# 用户权限体系详细说明

## 🎯 问题回答

**问**: 默认注册和默认角色是否具有基本能力（登录、文章、聊天、好友、群组的功能）？

**答**: **是的！** 现在的默认角色（"用户"）已经配置了完整的基本功能权限。

## ✅ 默认用户权限详情

### 🔐 基础功能权限

| 权限名称 | 功能描述 | 权限级别 | 条件限制 |
|---------|---------|---------|---------|
| USER_READ | 查看用户信息 | ✅ 已分配 | 只能查看自己的信息 |
| USER_UPDATE | 更新用户信息 | ✅ 已分配 | 只能更新自己的信息 |

### 💬 聊天功能权限

| 权限名称 | 功能描述 | 权限级别 | 条件限制 |
|---------|---------|---------|---------|
| MESSAGE_READ | 查看消息 | ✅ 已分配 | 只能查看自己的消息 |
| MESSAGE_CREATE | 发送消息 | ✅ 已分配 | 只能发送自己的消息 |
| MESSAGE_UPDATE | 编辑消息 | ✅ 已分配 | 只能编辑自己的消息 |
| MESSAGE_DELETE | 删除消息 | ✅ 已分配 | 只能删除自己的消息 |

### 👥 好友功能权限

| 权限名称 | 功能描述 | 权限级别 | 条件限制 |
|---------|---------|---------|---------|
| CONTACT_READ | 查看联系人 | ✅ 已分配 | 只能查看自己的联系人 |
| CONTACT_CREATE | 添加好友 | ✅ 已分配 | 可以添加新好友 |
| CONTACT_UPDATE | 更新联系人 | ✅ 已分配 | 只能更新自己的联系人 |
| CONTACT_DELETE | 删除好友 | ✅ 已分配 | 只能删除自己的好友 |

### 🔔 关注功能权限

| 权限名称 | 功能描述 | 权限级别 | 条件限制 |
|---------|---------|---------|---------|
| FOLLOW_READ | 查看关注 | ✅ 已分配 | 只能查看自己的关注列表 |
| FOLLOW_CREATE | 关注用户 | ✅ 已分配 | 可以关注其他用户 |
| FOLLOW_DELETE | 取消关注 | ✅ 已分配 | 可以取消关注用户 |

### 👥 群组功能权限

| 权限名称 | 功能描述 | 权限级别 | 条件限制 |
|---------|---------|---------|---------|
| GROUP_READ | 查看群组 | ✅ 已分配 | 只能查看自己加入的群组 |
| GROUP_CREATE | 创建群组 | ✅ 已分配 | 可以创建新群组（成为群主） |
| GROUP_JOIN | 加入群组 | ✅ 已分配 | 可以申请加入群组 |

### 📝 文章功能权限

| 权限名称 | 功能描述 | 权限级别 | 条件限制 |
|---------|---------|---------|---------|
| ARTICLE_READ | 查看文章 | ✅ 已分配 | 可以查看所有文章 |
| ARTICLE_CREATE | 创建文章 | ✅ 已分配 | 可以创建自己的文章 |
| ARTICLE_UPDATE | 更新文章 | ✅ 已分配 | 只能更新自己的文章 |
| ARTICLE_DELETE | 删除文章 | ✅ 已分配 | 只能删除自己的文章 |
| ARTICLE_FAVORITE | 收藏文章 | ✅ 已分配 | 可以收藏喜欢的文章 |
| ARTICLE_COMMENT | 评论文章 | ✅ 已分配 | 可以评论文章 |

### 📁 文件功能权限

| 权限名称 | 功能描述 | 权限级别 | 条件限制 |
|---------|---------|---------|---------|
| FILE_READ | 查看文件 | ✅ 已分配 | 只能查看自己的文件 |
| FILE_UPLOAD | 上传文件 | ✅ 已分配 | 可以上传自己的文件 |
| FILE_UPDATE | 更新文件 | ✅ 已分配 | 只能更新自己的文件 |
| FILE_DELETE | 删除文件 | ✅ 已分配 | 只能删除自己的文件 |
| FILE_SHARE | 分享文件 | ✅ 已分配 | 可以分享自己的文件 |

## 🏗️ 权限条件说明

### 条件类型含义

| 条件值 | 含义 | 举例 |
|--------|------|------|
| own | 自己的资源 | 用户只能操作自己创建的内容 |
| member | 群组成员 | 必须是群组成员才能查看群组 |
| admin | 群组管理员 | 必须是群管理员才能执行操作 |
| owner | 群组所有者 | 必须是群主才能执行操作 |
| any | 任何用户 | 无特殊限制，任何有权限的用户都可以 |

### 权限级别说明

| 权限类型 | 值 | 含义 |
|---------|----|------|
| status | 1 | 启用的权限 |
| status | 0 | 禁用的权限 |
| type | 1 | 业务权限（用户可用） |
| type | 0 | 系统权限（管理员专用） |

## 📋 用户角色功能对比

### 超级管理员 (admin)
- ✅ **所有权限**: 拥有系统中的所有功能权限
- ✅ **系统管理**: 用户管理、角色管理、系统配置
- ✅ **内容管理**: 所有文章、消息、文件的完全控制
- ✅ **高级功能**: 数据导出、系统日志、性能监控

### 管理员 (testuser)
- ✅ **用户管理**: 查看、管理普通用户
- ✅ **内容管理**: 管理所有文章和评论
- ✅ **基础功能**: 个人资料、消息、文件
- ✅ **社交功能**: 好友、群组、关注
- ❌ **系统配置**: 不能修改系统设置和角色

### 普通用户 (默认角色)
- ✅ **个人管理**: 查看和编辑自己的资料
- ✅ **文章功能**: 创建、编辑、删除自己的文章
- ✅ **聊天功能**: 发送消息、表情、文件传输
- ✅ **好友功能**: 添加好友、管理联系人
- ✅ **关注功能**: 关注其他用户、查看粉丝
- ✅ **群组功能**: 创建群组、加入群组、群聊
- ✅ **文件功能**: 上传、下载、分享文件
- ✅ **互动功能**: 点赞、收藏、评论

## 🔧 实现机制

### 1. 自动权限分配
```java
// 用户注册时自动分配默认角色
Role defaultRole = roleMapper.selectDefaultRole(); // 查找 is_default = true 的角色
userRoleMapper.assignRoleToUser(user.getId(), defaultRole.getId());
```

### 2. 权限验证流程
```java
// 请求访问资源时检查权限
@PreAuthorize("hasPermission(#userId, 'USER_READ')")
public User getUserInfo(Long userId) {
    // 只能查看自己的用户信息
}
```

### 3. 数据库权限关联
```sql
-- 用户角色关联
user_role: user_id ↔ role_id

-- 角色权限关联
role_permission: role_id ↔ permission_id

-- 权限条件判断
permission: resource + action + condition
```

## 🎮 使用示例

### 新用户注册后能做什么？

1. **登录系统** ✅
   - 使用用户名密码登录
   - 自动获得JWT令牌

2. **管理个人资料** ✅
   - 编辑头像、昵称、个人简介
   - 修改密码

3. **发表文章** ✅
   - 创建、编辑、删除自己的文章
   - 给他人文章点赞、评论、收藏

4. **聊天功能** ✅
   - 与好友私聊
   - 创建群聊
   - 发送文字、图片、文件

5. **社交功能** ✅
   - 添加好友
   - 关注其他用户
   - 查看关注者和粉丝

6. **群组功能** ✅
   - 创建自己的群组
   - 加入他人群组
   - 邀请成员加入群组

7. **文件管理** ✅
   - 上传个人文件
   - 分享文件给好友
   - 管理自己的文件库

## 🛡️ 安全保障

### 资源所有权验证
- 用户只能操作自己创建的资源
- 群组操作需要相应的成员身份
- 管理员权限受到严格限制

### 权限缓存机制
- 权限信息缓存在Redis中
- 支持权限动态更新
- 高效的权限检查性能

### 多重容错机制
- CustomUserDetailsService 提供备用权限
- 数据库初始化确保角色完整性
- 权限异常时自动降级处理

## 📊 总结

**默认注册用户拥有完整的基本功能**，包括：
- ✅ 登录和个人管理
- ✅ 文章创作和互动
- ✅ 实时聊天和群聊
- ✅ 好友管理和关注
- ✅ 群组创建和管理
- ✅ 文件上传和分享

这个权限体系确保了新用户注册后能够立即享受系统的核心功能，同时保护了用户数据的安全性和隐私性。