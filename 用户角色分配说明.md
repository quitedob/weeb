# 用户角色分配说明

## 🎯 角色分配策略

### 初始用户角色分配

| 用户名 | 密码 | 角色 | 权限级别 | 描述 |
|--------|------|------|----------|------|
| admin | admin123 | 超级管理员 | 1 | 系统最高权限，可以执行所有操作 |
| testuser | test123 | 管理员 | 10 | 系统管理员，可以管理用户和内容 |
| alice | password100 | 用户 | 100 | 普通用户，拥有基础权限 |
| bob | password200 | 用户 | 100 | 普通用户，拥有基础权限 |
| charlie | password300 | 用户 | 100 | 普通用户，拥有基础权限 |
| diana | password400 | 用户 | 100 | 普通用户，拥有基础权限 |
| eve | password500 | 用户 | 100 | 普通用户，拥有基础权限 |

### 新注册用户角色分配
- **自动分配**: 所有新注册的用户自动获得"用户"角色（默认角色）
- **权限**: 拥有基础的查看、创建、编辑、删除自己内容的权限

## 🔧 实现机制

### 1. 系统启动时自动分配
```java
// DatabaseInitializer.java - 系统启动时执行
assignRolesToInitialUsers() {
    // 清空现有的用户角色关联（重新分配）
    jdbcTemplate.update("DELETE FROM user_role");

    // 为特定用户分配角色
    assignRoleToUser("admin", superAdminRoleId, "超级管理员");
    assignRoleToUser("testuser", adminRoleId, "管理员");
    assignRoleToUser("alice", userRoleId, "用户");
    // ... 其他用户
}
```

### 2. 新用户注册时自动分配
```java
// AuthServiceImpl.java - 用户注册时执行
register(User user) {
    // ... 用户基本信息保存

    // 为新用户分配默认角色
    Role defaultRole = roleMapper.selectDefaultRole(); // 查找 is_default = true 的角色
    if (defaultRole != null) {
        userRoleMapper.assignRoleToUser(user.getId(), defaultRole.getId());
    }
}
```

### 3. 角色分配容错机制
```java
// 如果没有找到默认角色，尝试查找"用户"角色
Role userRole = roleMapper.selectByName("用户");
if (userRole != null) {
    userRoleMapper.assignRoleToUser(user.getId(), userRole.getId());
} else {
    log.warn("未找到合适的默认角色，新用户注册后无角色权限");
}
```

## 📋 角色权限详情

### 🌟 超级管理员 (admin)
- **系统管理**: 用户管理、角色管理、系统配置
- **内容管理**: 所有文章、评论、文件的完全控制
- **用户权限**: 查看、修改、删除任何用户信息
- **社交功能**: 创建群组、添加用户、发送消息
- **特殊权限**: 系统日志查看、数据备份恢复

### 👨‍💼 管理员 (testuser)
- **用户管理**: 查看、管理普通用户（不含超级管理员）
- **内容管理**: 管理所有文章和评论
- **基础功能**: 个人资料管理、消息发送
- **社交功能**: 创建群组、添加好友、聊天

### 👤 普通用户 (alice, bob, charlie, diana, eve + 新注册用户)
- **个人管理**: 查看和编辑自己的个人资料
- **文章功能**: 创建、编辑、删除自己的文章
- **评论功能**: 评论和管理自己的评论
- **社交功能**: 创建群组、添加好友、发送消息
- **文件管理**: 上传和管理自己的文件

## 🔍 验证步骤

### 1. 重启应用
系统会自动执行角色初始化和分配，你应该看到以下日志：
```
✅ 默认角色创建成功
✅ 基础权限创建成功
✅ 超级管理员权限分配完成
✅ 管理员权限分配完成
✅ 版主权限分配完成
✅ 普通用户权限分配完成
✅ 为用户 admin 分配角色: 超级管理员
✅ 为用户 testuser 分配角色: 管理员
✅ 为用户 alice 分配角色: 用户
✅ 为用户 bob 分配角色: 用户
✅ 为现有用户分配了默认角色
```

### 2. 测试各用户账号

#### admin 用户
- 登录: admin / admin123
- 权限测试: 应该能访问所有管理接口，包括用户管理、角色管理等

#### testuser 用户
- 登录: testuser / test123
- 权限测试: 应该能访问管理功能，但不能访问系统级管理

#### alice, bob 等普通用户
- 登录: alice / password100
- 权限测试: 应该能访问基础功能，包括 `/api/users/me`

#### 新注册用户
- 注册任意新用户
- 权限测试: 自动获得用户角色，能访问基础功能

### 3. 数据库验证
```sql
-- 查看用户角色分配情况
SELECT u.username, r.name as role_name, u.registration_date
FROM user u
JOIN user_role ur ON u.id = ur.user_id
JOIN role r ON ur.role_id = r.id
ORDER BY u.registration_date;

-- 查看角色权限分配情况
SELECT r.name as role_name, COUNT(rp.permission_id) as permission_count
FROM role r
LEFT JOIN role_permission rp ON r.id = rp.role_id
GROUP BY r.id, r.name
ORDER BY r.level;
```

## 🛠️ 故障排除

### 如果用户仍然无法访问 `/api/users/me`

1. **检查日志**: 确认角色分配是否成功
2. **检查数据库**: 确认 user_role 表中是否有对应记录
3. **手动分配**: 可以通过数据库手动分配角色
```sql
-- 手动为用户分配角色
INSERT INTO user_role (user_id, role_id, created_at)
SELECT u.id, r.id, NOW()
FROM user u, role r
WHERE u.username = '用户名' AND r.name = '用户';
```

## 🎉 总结

通过这个完整的角色分配体系：

1. **初始用户**: 明确的角色分工，便于测试和管理
2. **新注册用户**: 自动获得基础权限，确保正常使用
3. **权限控制**: 分层级的权限管理，确保系统安全
4. **容错机制**: 多重保障，确保用户总能有基本权限

这样就彻底解决了 "Access Denied" 问题，并建立了一个完整的用户角色管理体系！🚀