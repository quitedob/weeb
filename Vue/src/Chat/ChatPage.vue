<template>
  <!-- ‰∏ªËÅäÂ§©ÂÆπÂô® -->
  <div class="chat-container">
    <!-- Êñá‰ª∂‰º†ËæìÂºπÁ™óÔºàÂç†‰ΩçÁ§∫‰æãÔºâ -->
    <div v-if="fileInfo.fileVisible">
      <!-- ÈÅÆÁΩ©Â±Ç -->
      <div class="mask"></div>
      <!-- Êñá‰ª∂‰º†ËæìÂºπÁ™ó -->
      <div class="file-transfer-modal">
        <h3>Êñá‰ª∂‰º†Ëæì(Âç†‰Ωç)</h3>
        <p>ÁõÆÊ†áÔºö{{ fileInfo.fileTargetInfo }}</p>
        <p>Êñá‰ª∂Ôºö{{ fileInfo.fileName }}</p>
        <!-- ÁÇπÂáªÂÖ≥Èó≠ÊåâÈíÆÈöêËóèÂºπÁ™ó -->
        <button @click="fileInfo.fileVisible = false">ÂÖ≥Èó≠</button>
      </div>
    </div>

  
    <!-- Áî®Êà∑‰ø°ÊÅØ‰øÆÊîπÂºπÁ™óÔºàÂç†‰ΩçÁ§∫‰æãÔºâ -->
    <div v-if="modifyUserInfoIsOpen">
      <div class="mask"></div>
      <div class="modify-user-modal">
        <h3>Áî®Êà∑‰ø°ÊÅØ‰øÆÊîπ(Âç†‰Ωç)</h3>
        <p>
          Áî®Êà∑Âêç:
          <!-- ÂèåÂêëÁªëÂÆöÁî®Êà∑ÂêçÁß∞ -->
          <input v-model="userInfoStore.userName" />
        </p>
        <button @click="modifyUserInfoIsOpen = false">ÂÖ≥Èó≠</button>
      </div>
    </div>

    <!-- Ë°®ÊÉÖÂºπÁ™ó -->
    <div
        v-if="isEmojiVisible"
        class="emoji-popup"
        :style="{
        top: emojiPosition.y + 'px',
        left: emojiPosition.x + 'px',
        width: inputAreaWidth + 'px'
      }"
    >
      <h4 class="emoji-title">Ë°®ÊÉÖÂºπÁ™ó</h4>
      <!-- Ë°®ÊÉÖÊêúÁ¥¢Ê°ÜÂÆπÂô® -->
      <div class="emoji-search-container">
        <input
            v-model="emojiSearchValue"
            type="text"
            placeholder="ÊêúÁ¥¢Ë°®ÊÉÖ"
            class="emoji-search-input"
        />
      </div>
      <!-- Ë°®ÊÉÖÁΩëÊ†ºÂ±ïÁ§∫Âå∫Âüü -->
      <div class="emoji-grid">
        <div
            v-for="(item, idx) in paginatedEmojis"
            :key="idx"
            :title="item.name"
            class="emoji-item"
            @click="insertEmoji(item.icon)"
        >
          {{ item.icon }}
        </div>
      </div>
      <!-- Ë°®ÊÉÖÂàÜÈ°µÊéßÂà∂ -->
      <div class="emoji-pagination">
        <button
            class="emoji-pagination-button"
            @click="prevPage"
            :disabled="currentEmojiPage === 1"
        >
          ‰∏ä‰∏ÄÈ°µ
        </button>
        <span class="emoji-pagination-info">Á¨¨ {{ currentEmojiPage }} / {{ totalPages }} È°µ</span>
        <button
            class="emoji-pagination-button"
            @click="nextPage"
            :disabled="currentEmojiPage === totalPages"
        >
          ‰∏ã‰∏ÄÈ°µ
        </button>
      </div>
      <!-- Ë°®ÊÉÖÂåÖÂàáÊç¢ÊåâÈíÆ -->
      <div class="emoji-package-container">
        <button
            v-for="(pkg, pkgIndex) in filteredEmojisList"
            :key="pkgIndex"
            @click="switchPackage(pkgIndex)"
            :class="['emoji-package-button', { active: currentPackageIndex === pkgIndex }]"
        >
          {{ pkg.name }}
        </button>
      </div>
      <!-- ÂÖ≥Èó≠Ë°®ÊÉÖÂºπÁ™óÊåâÈíÆ -->
      <button class="emoji-close-button" @click="closeEmojiPopup">ÂÖ≥Èó≠</button>
    </div>

    <!-- ËÅäÂ§©ËÉåÊôØÂèä‰∏ªË¶ÅËÅäÂ§©Âå∫Âüü -->
    <div class="chat-bg">
      <div class="chat-box">
        <!-- Â∑¶‰æßËèúÂçïÔºàËÅäÂ§©ÂàóË°®Ôºâ -->
        <div class="box-left" :class="{ 'show-left': showLeft }">
          <div class="chat-list-title">
            <div>Ê∂àÊÅØÂàóË°®</div>
            <div class="close-btn" @click="showLeft = false">√ó</div>
          </div>
          <!-- Áæ§ËÅäÈ°π -->
          <div
              class="chat-list-item group-chat"
              @click="() => { targetId = '1'; closeMask(); }"
          >
            <div class="chat-avatar"></div>
            <div class="chat-item-content">
              <div class="chat-content-name">{{ groupChat.targetInfo?.name }}</div>
              <div class="chat-content-msg">{{ groupChat.lastMessage }}</div>
            </div>
          </div>
          <!-- ÁßÅËÅäÊ†áÈ¢ò -->
          <div v-if="privateChatList.length > 0" class="private-chat-title">
            ÁßÅËÅä
          </div>
          <!-- ÁßÅËÅäÂàóË°® -->
          <div class="chat-list-content">
            <div
                v-for="item in privateChatList"
                :key="item.id"
                :class="['chat-list-item', targetId === item.targetId ? 'active-chat' : '']"
                @click="() => { targetId = item.targetId; currentSelectTarget = item; closeMask(); }"
            >
              <div class="chat-avatar-small"></div>
              <div class="chat-item-content">
                <div class="chat-content-name">{{ item.targetInfo.name }}</div>
                <div class="chat-content-msg">{{ item.lastMessage }}</div>
              </div>
              <!-- ÁßªÈô§ÁßÅËÅäÈ°πÊåâÈíÆ -->
              <button
                  v-if="targetId === item.targetId"
                  class="delete-chat-button"
                  @click="onDeleteChatList(item.id)"
              >
                ÁßªÈô§
              </button>
            </div>
          </div>
          <!-- ÂπøÂëäÁ§∫‰æã -->
          <div class="ad-container">
            <img
                src="/ad.png"
                alt="ÂπøÂëä"
                class="ad-image"
                @click="handlerCardClick({ key: 'ad' })"
            />
          </div>
        </div>

        <!-- ÁßªÂä®Á´ØÈÅÆÁΩ©ÔºåÁÇπÂáªÂÖ≥Èó≠ÊäΩÂ±â -->
        <div class="mask" v-if="showLeft || showRight" @click="closeMask"></div>

        <!-- ‰∏≠Èó¥ÈÉ®ÂàÜÔºàËÅäÂ§©Ê∂àÊÅØÂ±ïÁ§∫ÂèäËæìÂÖ•Âå∫ÂüüÔºâ -->
        <div class="box-middle">
          <div class="middle-top">
            <!-- Â∑¶‰æßËèúÂçïÊåâÈíÆ -->
            <div class="menu-btn" @click="showLeft = true">‚â°</div>
            <!-- ÊòæÁ§∫ÂΩìÂâçËÅäÂ§©ÂØπË±°ÂêçÁß∞ÔºàÁæ§ËÅäÊàñÁßÅËÅäÔºâ -->
            <template v-if="targetId === '1'">
              {{ groupChat.targetInfo?.name }}
            </template>
            <template v-else>
              {{ currentSelectTarget?.targetInfo?.name }}
            </template>
            <!-- Âè≥‰æßËèúÂçïÊåâÈíÆ -->
            <div class="menu-btn" @click="showRight = true">‚öô</div>
          </div>
          <!-- ËÅäÂ§©Ê∂àÊÅØÂ±ïÁ§∫Âå∫ÂèäËæìÂÖ•Âå∫ -->
          <div class="middle-content">
            <!-- Ê∂àÊÅØÂ±ïÁ§∫Âå∫ -->
            <div class="chat-show-area" ref="chatShowAreaRef">
              <div
                  v-for="msg in msgRecord"
                  :key="msg.id || msg.tempId"
                  class="msg-item"
                  :style="{
                  justifyContent: msg.fromId === userInfoStore.userId ? 'flex-end' : 'flex-start'
                }"
              >
                <div class="chat-message-container">
                  <!-- Â¶ÇÊûúÊ∂àÊÅØÂ∑≤Êí§ÂõûÂàôÊòæÁ§∫ÊèêÁ§∫ÔºåÂê¶ÂàôÊòæÁ§∫Ê∂àÊÅØÂÜÖÂÆπ -->
                  <div class="bubble" :class="{ 'sent-message': msg.fromId === userInfoStore.userId }">
                    <div v-if="msg.isRecalled === 1">Ê∂àÊÅØÂ∑≤Êí§Âõû</div>
                    <div v-else-if="msg.messageType === 2 && msg.fileData" class="file-message">
                      <div class="file-message-content" @click="downloadFile(msg.fileData)">
                        <div class="file-icon">üìÑ</div>
                        <div class="file-details">
                          <div class="file-name">{{ msg.fileData.fileName }}</div>
                          <div class="file-size">{{ formatFileSize(msg.fileData.fileSize) }}</div>
                        </div>
                        <div class="download-hint">ÁÇπÂáª‰∏ãËΩΩ</div>
                      </div>
                    </div>
                    <div v-else>{{ msg.msgContent }}</div>
                  </div>
                  <!-- Ê∂àÊÅØÁä∂ÊÄÅÂíåÊìç‰ΩúÊåâÈíÆÂÆπÂô® -->
                  <div class="message-actions">
                    <!-- Ê∂àÊÅØÁä∂ÊÄÅÊåáÁ§∫Âô® -->
                    <div v-if="msg.fromId === userInfoStore.userId" class="message-status">
                      <span v-if="msg.status === 'sending'" class="status-sending">ÂèëÈÄÅ‰∏≠...</span>
                      <span v-else-if="msg.status === 'sent'" class="status-sent">Â∑≤ÂèëÈÄÅ</span>
                      <span v-else-if="msg.status === 'delivered'" class="status-delivered">Â∑≤ÈÄÅËææ</span>
                      <span v-else-if="msg.status === 'read'" class="status-read">Â∑≤ËØª</span>
                    </div>
                    <!-- Êó∂Èó¥Êà≥ -->
                    <div class="message-time">
                      {{ formatMessageTime(msg.timestamp) }}
                    </div>
                    <!-- Êí§ÂõûÊåâÈíÆÔºö‰ªÖÂØπÂΩìÂâçÁî®Êà∑Ëá™Â∑±ÂèëÈÄÅÁöÑ‰∏îÊ∂àÊÅØÊú™Êí§ÂõûÊó∂ÊòæÁ§∫ -->
                    <button v-if="msg.fromId === userInfoStore.userId && msg.isRecalled !== 1" class="recall-btn" @click="handleRecallMessage(msg.id || msg.tempId)">
                      Êí§Âõû
                    </button>
                  </div>
                </div>
              </div>
              <!-- Ê≠£Âú®ÂèëÈÄÅÊèêÁ§∫ -->
              <div v-if="isSendLoading" class="sending-indicator">
                <strong>ÂèëÈÄÅ‰∏≠...</strong>
              </div>

              <!-- ÊâìÂ≠óÊåáÁ§∫Âô® -->
              <div v-if="chatStore.isTypingInCurrentChat" class="typing-indicator">
                <div class="typing-dots">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
                <span class="typing-text">{{ getTypingUsersText() }}</span>
              </div>

              <!-- Êñ∞Ê∂àÊÅØËÆ°Êï∞ÔºåÁÇπÂáªÊªöÂä®Âà∞Â∫ïÈÉ® -->
              <div v-if="currentNewMsgCount > 0" class="new-msg-count" @click="scrollToBottom">
                ‚ñº {{ currentNewMsgCount }} Êù°Êñ∞Ê∂àÊÅØ
              </div>
            </div>
            <!-- ËÅäÂ§©ËæìÂÖ•Âå∫ -->
            <div
              class="chat-input-area"
              @dragover.prevent="handleDragOver"
              @dragleave.prevent="handleDragLeave"
              @drop.prevent="handleFileDrop"
              :class="{ 'drag-over': isDragOver }"
            >
              <div class="chat-input-container" ref="inputAreaRef">
                <!-- ÂºïÁî®Ê∂àÊÅØÊòæÁ§∫Âå∫Âüü -->
                <div v-if="msgStore.referenceMsg" class="reference-msg">
                  <div class="reference-msg-content">
                    {{ msgStore.referenceMsg.fromId }}: {{ msgStore.referenceMsg.msgContent }}
                  </div>
                  <button @click="msgStore.referenceMsg = null">X</button>
                </div>
                <!-- Ë°®ÊÉÖÊåâÈíÆ -->
                <div class="emoji-button" @click="handlerSetEmojiBoxPosition">
                  üòä
                </div>
                <!-- Êñá‰ª∂‰∏ä‰º†ÊåâÈíÆ -->
                <div class="file-button" @click="triggerFileUpload" title="ÂèëÈÄÅÊñá‰ª∂">
                  üìé
                </div>
                <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ•Ê°Ü -->
                <input
                    ref="fileInputRef"
                    type="file"
                    style="display: none"
                    @change="handleFileSelect"
                    :disabled="fileUploadState.isUploading"
                />
                <!-- Ê∂àÊÅØËæìÂÖ•Ê°Ü -->
                <div class="chat-msg-input">
                  <input
                      v-model="msgContent"
                      type="text"
                      placeholder="ËØ∑ËæìÂÖ•Ê∂àÊÅØ"
                      class="chat-text-input"
                      @keyup.enter="handlerSubmitMsg"
                      @input="handleTypingInput"
                  />
                </div>
              </div>
              <!-- Êñá‰ª∂È¢ÑËßàÂå∫Âüü -->
              <div v-if="fileUploadState.selectedFile" class="file-preview-container">
                <div class="file-preview">
                  <div class="file-info">
                    <span class="file-name">{{ fileUploadState.selectedFile.name }}</span>
                    <span class="file-size">({{ formatFileSize(fileUploadState.selectedFile.size) }})</span>
                  </div>
                  <div class="file-actions">
                    <button @click="clearFileSelection" class="remove-file-btn" title="ÁßªÈô§Êñá‰ª∂">
                      ‚ùå
                    </button>
                  </div>
                </div>
                <!-- ‰∏ä‰º†ËøõÂ∫¶Êù° -->
                <div v-if="fileUploadState.isUploading" class="upload-progress">
                  <div class="progress-bar">
                    <div
                      class="progress-fill"
                      :style="{ width: fileUploadState.uploadProgress + '%' }"
                    ></div>
                  </div>
                  <span class="progress-text">{{ fileUploadState.uploadProgress }}%</span>
                </div>
              </div>
              <!-- ÂèëÈÄÅÊåâÈíÆÔºöÂΩìËæìÂÖ•‰∏∫Á©∫Êó∂Á¶ÅÁî®ÔºåÂπ∂ÊòæÁ§∫ÁÅ∞Ëâ≤ -->
              <button
                  class="publish-button"
                  :disabled="(!msgContent.trim() && !fileUploadState.selectedFile) || fileUploadState.isUploading"
                  @click="handlerSubmitMsg"
              >
                {{ fileUploadState.isUploading ? 'ÂèëÈÄÅ‰∏≠...' : 'ÂèëÈÄÅ' }}
              </button>
            </div>
          </div>
        </div>

        <!-- Âè≥‰æßËèúÂçï -->
        <div class="box-right" :class="{ 'show-right': showRight }">
          <div class="right-top">
            <div class="user-info">
              <!-- ÁÇπÂáªÂ§¥ÂÉèÂèØÊâìÂºÄÁî®Êà∑‰ø°ÊÅØ‰øÆÊîπÂºπÁ™ó -->
              <div class="avatar2" @click="modifyUserInfoIsOpen = true"></div>
              <div class="user-name">{{ userInfoStore.userName }}</div>
            </div>
            <div class="right-btn-group">
              <button @click="toggleDark">ÂàáÊç¢‰∏ªÈ¢ò</button>
              <button @click="handlerLogout">ÈÄÄÂá∫</button>
            </div>
          </div>
          <div class="right-content">
            <div class="user-list-header">
              <!-- Âú®Á∫ø‰∫∫Êï∞‰ΩøÁî®ÈÄöËøáÊé•Âè£Ëé∑ÂèñÁöÑÂú®Á∫øÁî®Êà∑Êï∞ÊçÆ -->
              <div class="online-count">Âú®Á∫ø‰∫∫Êï∞ ({{ onlineCount }})</div>
              <!-- Áî®Êà∑ÊêúÁ¥¢ËæìÂÖ•Ê°Ü -->
              <input
                  v-model="userSearchValue"
                  type="text"
                  placeholder="ÊêúÁ¥¢Áî®Êà∑"
                  class="user-search-input"
              />
            </div>
            <!-- Âú®Á∫øÁî®Êà∑ÂàóË°® -->
            <div class="online-list">
              <div
                  v-for="(item, index) in userListFiltered"
                  :key="item.id"
                  class="online-list-item"
                  :class="{ odd: index % 2 === 0 }"
              >
                <div class="online-item-content">
                  <div class="avatar1"></div>
                  <!-- Ê≥®ÊÑèÔºöÂêéÁ´ØËøîÂõûÁöÑÁî®Êà∑Â≠óÊÆµ‰∏∫ username -->
                  <div class="online-username">{{ item.username }}</div>
                </div>
                <div class="online-item-operation">
                  <button
                      v-if="item.id !== userInfoStore.userId"
                      @click="() => { onCreatePrivateChat(item.id, item.username); closeMask(); }"
                  >
                    ÁßÅËÅä
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Âè≥‰æßËèúÂçïÁªìÊùü -->
      </div>
    </div>
  </div>
</template>

<script setup>
/* ---------------------- ÂØºÂÖ• Vue ÂìçÂ∫îÂºè API ‰ª•ÂèäÂÖ∂‰ªñ‰æùËµñ ---------------------- */
import { ref, computed, onMounted, onUnmounted, watch } from 'vue'
// ÂØºÂÖ• API Ê®°Âùó
import { getUserList, getUserMap, getOnlineUsers } from '../api/modules/user'
import { sendMessage, getChatRecord, recallMessage } from '../api/modules/message'
import fileManagementApi from '../api/modules/fileManagement'
// ÂØºÂÖ•Â∑•ÂÖ∑ÂáΩÊï∞
import { generateUUID } from '@/utils/uuid'
// ÂØºÂÖ•Ë°®ÊÉÖÂåÖÊï∞ÊçÆÔºàËØ∑Á°Æ‰øùË∑ØÂæÑÊ≠£Á°ÆÔºâ
import emojis from '@constant/emoji/emoji.js'
// ÂØºÂÖ• Vue Router Áî®‰∫éÈ°µÈù¢Ë∑≥ËΩ¨
import { useRouter } from 'vue-router'
// ÂØºÂÖ• ChatStore Áî®‰∫éWebSocketËøûÊé•ÁÆ°ÁêÜ
import { useChatStore } from '@/stores/chatStore'
// ÂØºÂÖ• AuthStore Áî®‰∫éËé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
import { useAuthStore } from '@/stores/authStore'

const router = useRouter()
const chatStore = useChatStore()
const authStore = useAuthStore()

/* ---------------------- Â∑¶‰æß/Âè≥‰æßÊäΩÂ±âÊéßÂà∂ ---------------------- */
// Â∑¶‰æßËèúÂçïÊòæÁ§∫Áä∂ÊÄÅ
const showLeft = ref(false)
// Âè≥‰æßËèúÂçïÊòæÁ§∫Áä∂ÊÄÅ
const showRight = ref(false)

/* ---------------------- Áî®Êà∑‰ø°ÊÅØ‰øÆÊîπÂºπÁ™ó ---------------------- */
const modifyUserInfoIsOpen = ref(false)

/* ---------------------- Ë°®ÊÉÖÂºπÁ™óÈÄªËæë ---------------------- */
// ÊéßÂà∂Ë°®ÊÉÖÂºπÁ™óÊòæÁ§∫Áä∂ÊÄÅ
const isEmojiVisible = ref(false)
// Ë°®ÊÉÖÂºπÁ™óÁöÑÊòæÁ§∫‰ΩçÁΩÆÔºàx, y ÂùêÊ†áÔºâ
const emojiPosition = ref({ x: 0, y: 0 })
// Ëé∑ÂèñËæìÂÖ•Âå∫ÂüüÁöÑÂÆΩÂ∫¶ÔºàÁî®‰∫éËÆæÁΩÆË°®ÊÉÖÂºπÁ™óÂÆΩÂ∫¶Ôºâ
const inputAreaRef = ref(null)
const inputAreaWidth = ref(300)

// Ë°®ÊÉÖÂåÖÊï∞ÊçÆÔºà‰ªéÂ§ñÈÉ®Êñá‰ª∂ÂºïÂÖ•Ôºâ
const emojisList = emojis
// ÂΩìÂâçÈÄâ‰∏≠ÁöÑË°®ÊÉÖÂåÖÁ¥¢Âºï
const currentPackageIndex = ref(0)
// ÊØèÈ°µÊòæÁ§∫ÁöÑË°®ÊÉÖÊï∞Èáè
const pageSize = 30
// ÂΩìÂâçË°®ÊÉÖÂàÜÈ°µÈ°µÁ†Å
const currentEmojiPage = ref(1)
// Ë°®ÊÉÖÊêúÁ¥¢ÂÖ≥ÈîÆËØç
const emojiSearchValue = ref('')

// Ê†πÊçÆÊêúÁ¥¢ÂÖ≥ÈîÆËØçËøáÊª§Ë°®ÊÉÖÂåÖÊï∞ÊçÆ
const filteredEmojisList = computed(() => {
  const searchVal = emojiSearchValue.value.trim().toLowerCase()
  if (!searchVal) return emojisList
  return emojisList.map(pkg => {
    const filteredList = pkg.list.filter(item => {
      return (
          item.name.toLowerCase().includes(searchVal) ||
          (item.icon || '').includes(searchVal)
      )
    })
    return { ...pkg, list: filteredList }
  })
})

// ÂΩìÂâçÈÄâ‰∏≠Ë°®ÊÉÖÂåÖ
const currentPackage = computed(() => {
  if (
      currentPackageIndex.value < 0 ||
      currentPackageIndex.value >= filteredEmojisList.value.length
  ) {
    return { name: '', list: [] }
  }
  return filteredEmojisList.value[currentPackageIndex.value]
})
// ÂΩìÂâçË°®ÊÉÖÊÄªÊï∞
const totalEmojis = computed(() => currentPackage.value.list.length)
// ËÆ°ÁÆóÊÄªÈ°µÊï∞
const totalPages = computed(() => Math.ceil(totalEmojis.value / pageSize))
// Ëé∑ÂèñÂΩìÂâçÈ°µÊòæÁ§∫ÁöÑË°®ÊÉÖÂàóË°®
const paginatedEmojis = computed(() => {
  const startIndex = (currentEmojiPage.value - 1) * pageSize
  return currentPackage.value.list.slice(startIndex, startIndex + pageSize)
})

// ÂàáÊç¢Ë°®ÊÉÖÂåÖÔºåÂêåÊó∂ÈáçÁΩÆÂàÜÈ°µ
function switchPackage(index) {
  currentPackageIndex.value = index
  currentEmojiPage.value = 1
}

// ÂàÜÈ°µÔºö‰∏ä‰∏ÄÈ°µ
function prevPage() {
  if (currentEmojiPage.value > 1) currentEmojiPage.value--
}
// ÂàÜÈ°µÔºö‰∏ã‰∏ÄÈ°µ
function nextPage() {
  if (currentEmojiPage.value < totalPages.value) currentEmojiPage.value++
}

// ÊèíÂÖ•Ë°®ÊÉÖÂà∞Ê∂àÊÅØËæìÂÖ•Ê°Ü
function insertEmoji(emojiIcon) {
  msgContent.value += emojiIcon
  isEmojiVisible.value = false
}

// ÂÖ≥Èó≠Ë°®ÊÉÖÂºπÁ™óÂπ∂Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°Ü
function closeEmojiPopup() {
  isEmojiVisible.value = false
  emojiSearchValue.value = ''
}

// ËÆæÁΩÆË°®ÊÉÖÂºπÁ™óÊòæÁ§∫ÁöÑ‰ΩçÁΩÆÂèäÂÆΩÂ∫¶ÔºåÂπ∂ÂàáÊç¢ÊòæÁ§∫Áä∂ÊÄÅ
function handlerSetEmojiBoxPosition(e) {
  if (!inputAreaRef.value) return
  // Ëé∑ÂèñËæìÂÖ•Âå∫Âüü‰ΩçÁΩÆÂèäÂÆΩÂ∫¶
  const rect = inputAreaRef.value.getBoundingClientRect()
  const popupHeight = 400 // ÂºπÁ™óÈ´òÂ∫¶È¢ÑËÆæÂÄº
  const popupWidth = 320 // ÂºπÁ™óÂÆΩÂ∫¶È¢ÑËÆæÂÄº
  const viewportWidth = window.innerWidth
  const viewportHeight = window.innerHeight

  // ËÆ°ÁÆóÂêàÈÄÇÁöÑx‰ΩçÁΩÆÔºåÁ°Æ‰øù‰∏çË∂ÖÂá∫ËßÜÁ™óËæπÁïå
  let x = rect.left
  if (x + popupWidth > viewportWidth) {
    x = viewportWidth - popupWidth - 10 // Áïô10pxËæπË∑ù
  }
  if (x < 10) {
    x = 10 // Áïô10pxËæπË∑ù
  }

  // ËÆ°ÁÆóÂêàÈÄÇÁöÑy‰ΩçÁΩÆÔºåÁ°Æ‰øù‰∏çË∂ÖÂá∫ËßÜÁ™óËæπÁïå
  let y = rect.top - popupHeight
  if (y < 10) {
    // Â¶ÇÊûú‰∏äÊñπÁ©∫Èó¥‰∏çÂ§üÔºåÊòæÁ§∫Âú®ËæìÂÖ•Ê°Ü‰∏ãÊñπ
    y = rect.bottom + 10
  }

  emojiPosition.value.x = x
  emojiPosition.value.y = y
  inputAreaWidth.value = Math.min(rect.width, popupWidth)
  // ÂàáÊç¢Ë°®ÊÉÖÂºπÁ™óÊòæÁ§∫Áä∂ÊÄÅ
  isEmojiVisible.value = !isEmojiVisible.value
}

/* ---------------------- ËÅäÂ§©ÈÄªËæë ---------------------- */
// Êñá‰ª∂‰∏ä‰º†Áõ∏ÂÖ≥Áä∂ÊÄÅ
const fileUploadState = ref({
  isUploading: false,
  uploadProgress: 0,
  selectedFile: null,
  filePreview: null
})
// ÊãñÊãΩ‰∏ä‰º†Áä∂ÊÄÅ
const isDragOver = ref(false)
// Ê∂àÊÅØËæìÂÖ•Ê°ÜÂÜÖÂÆπ
const msgContent = ref('')
// Ê∂àÊÅØÂèëÈÄÅ‰∏≠Áä∂ÊÄÅ
const isSendLoading = ref(false)
// Êñ∞Ê∂àÊÅØËÆ°Êï∞ÔºàÁ§∫‰æãÔºâ
const currentNewMsgCount = ref(0)

// Áæ§ËÅäÁ§∫‰æãÊï∞ÊçÆ
const groupChat = ref({
  targetInfo: { name: 'Áæ§ËÅäÁ§∫‰æã' },
  lastMessage: 'ËøôÈáåÊòØÊúÄÂêé‰∏ÄÊù°Áæ§ËÅäÊ∂àÊÅØ'
})
// ÁßÅËÅäÂàóË°®Á§∫‰æãÊï∞ÊçÆÔºàÂàùÂßã‰∏∫Á©∫ÔºåÁÇπÂáªÁßÅËÅäÂêéÂàõÂª∫Ôºâ
const privateChatList = ref([])
// ÂΩìÂâçËÅäÂ§©ÂØπË±° IDÔºå'1' Ë°®Á§∫Áæ§ËÅä
const targetId = ref('1')
// ÂΩìÂâçÈÄâ‰∏≠ÁöÑÁßÅËÅäÂØπË±°
const currentSelectTarget = ref(null)
// Ê∂àÊÅØËÆ∞ÂΩïÔºàÂàùÂßãÂåñ‰∏∫Á©∫ÔºåÂêéÁª≠ÈÄöËøáÊé•Âè£Âä†ËΩΩÔºâ
const msgRecord = ref([])

// Áî®Êà∑‰ø°ÊÅØÂ≠òÂÇ®
const userInfoStore = computed(() => ({
  userId: authStore.currentUser?.id || 1,
  userName: authStore.currentUser?.username || 'Ëá™Â∑±',
  referenceMsg: null
}))

// Ê∂àÊÅØÂºïÁî®Â≠òÂÇ®ÔºàÁ§∫‰æãÊï∞ÊçÆÔºâ
const msgStore = {
  referenceMsg: null
}

// Êñá‰ª∂ËæìÂÖ•Ê°ÜÂºïÁî®
const fileInputRef = ref(null)

// ÊâìÂ≠óÁõ∏ÂÖ≥ÂèòÈáè
let typingTimeout = null
const isTyping = ref(false)

/* ---------------------- Áî®Êà∑Áõ∏ÂÖ≥Êï∞ÊçÆ ---------------------- */
// Áî®Êà∑ÂàóË°®ÔºàÈÄöËøáÊé•Âè£Ëé∑ÂèñÔºâ
const userList = ref([])
// Áî®Êà∑ MapÔºàÈÄöËøáÊé•Âè£Ëé∑ÂèñÔºâ
const userMap = ref({})
// Âú®Á∫øÁî®Êà∑ÂàóË°®ÔºàÈÄöËøáÊé•Âè£Ëé∑ÂèñÔºâ
const onlineUsers = ref([])
// Áî®Êà∑ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
const userSearchValue = ref('')

// Ê†πÊçÆÊêúÁ¥¢ÂÖ≥ÈîÆËØçËøáÊª§Áî®Êà∑ÂàóË°®Ôºà‰ΩøÁî® username Â≠óÊÆµÔºâ
const userListFiltered = computed(() => {
  if (!userSearchValue.value.trim()) return userList.value
  return userList.value.filter(item => item.username.includes(userSearchValue.value))
})
// Âú®Á∫øÁî®Êà∑Êï∞ÈáèÔºà‰ΩøÁî®Âú®Á∫øÁî®Êà∑Êé•Âè£ËøîÂõûÁöÑÊï∞ÊçÆÔºâ
const onlineCount = computed(() => onlineUsers.value.length)

/* ---------------------- Êé•Âè£Ë∞ÉÁî®ÂáΩÊï∞ ---------------------- */
/**
 * Ëé∑ÂèñÁî®Êà∑ÂàóË°®Êé•Âè£
 */
async function fetchUserList() {
  try {
    const res = await getUserList()
    if (res.code === 0) {
      userList.value = res.data || []
    }
  } catch (error) {
    console.error("Ëé∑ÂèñÁî®Êà∑ÂàóË°®Âá∫Èîô:", error)
  }
}

/**
 * Ëé∑ÂèñÁî®Êà∑ Map Êé•Âè£
 */
async function fetchUserMap() {
  try {
    const res = await getUserMap()
    if (res.code === 0) {
      userMap.value = res.data || {}
    }
  } catch (error) {
    console.error("Ëé∑ÂèñÁî®Êà∑ Map Âá∫Èîô:", error)
  }
}

/**
 * Ëé∑ÂèñÂú®Á∫øÁî®Êà∑Êé•Âè£
 */
async function fetchOnlineUsers() {
  try {
    const res = await getOnlineUsers()
    if (res.code === 0) {
      onlineUsers.value = res.data || []
    }
  } catch (error) {
    console.error("Ëé∑ÂèñÂú®Á∫øÁî®Êà∑Âá∫Èîô:", error)
  }
}

/**
 * Ëé∑ÂèñËÅäÂ§©ËÆ∞ÂΩïÊé•Âè£
 * Ë∞ÉÁî®ÂêéÁ´Ø /api/v1/message/record Êé•Âè£Ëé∑ÂèñÂΩìÂâçËÅäÂ§©ÂØπË±°ÁöÑÊ∂àÊÅØËÆ∞ÂΩï
 */
async function fetchChatRecord() {
  try {
    const payload = {
      targetId: targetId.value,
      index: 0,
      num: 50
    }
    const res = await getChatRecord(targetId.value, 0, 50)
    if (res.code === 0) {
      msgRecord.value = res.data || []
    }
  } catch (error) {
    console.error("Ëé∑ÂèñËÅäÂ§©ËÆ∞ÂΩïÂá∫Èîô:", error)
  }
}

/**
 * Ëß¶ÂèëÊñá‰ª∂ÈÄâÊã©
 */
function triggerFileUpload() {
  fileInputRef.value?.click()
}

/**
 * Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
 */
function handleFileSelect(event) {
  const file = event.target.files[0]
  if (!file) return

  // È™åËØÅÊñá‰ª∂
  if (!validateFile(file)) {
    event.target.value = '' // Ê∏ÖÁ©∫ËæìÂÖ•
    return
  }

  fileUploadState.value.selectedFile = file
  fileUploadState.value.filePreview = URL.createObjectURL(file)
}

/**
 * È™åËØÅÊñá‰ª∂
 */
function validateFile(file) {
  // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂‰∏∫10MBÔºâ
  const maxSize = 10 * 1024 * 1024 // 10MB
  if (file.size > maxSize) {
    alert('Êñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá10MB')
    return false
  }

  // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûãÔºàÂèØÊ†πÊçÆÈúÄË¶ÅÊâ©Â±ïÔºâ
  const allowedTypes = ['image/*', 'application/pdf', 'text/*', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document']
  const isAllowed = allowedTypes.some(type => {
    if (type.endsWith('/*')) {
      return file.type.startsWith(type.slice(0, -1))
    }
    return file.type === type
  })

  if (!isAllowed) {
    alert('‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûã')
    return false
  }

  return true
}

/**
 * Â§ÑÁêÜÊãñÊãΩÊÇ¨ÂÅú
 */
function handleDragOver(event) {
  event.preventDefault()
  isDragOver.value = true
}

/**
 * Â§ÑÁêÜÊãñÊãΩÁ¶ªÂºÄ
 */
function handleDragLeave(event) {
  event.preventDefault()
  isDragOver.value = false
}

/**
 * Â§ÑÁêÜÊñá‰ª∂ÊãñÊîæ
 */
function handleFileDrop(event) {
  event.preventDefault()
  isDragOver.value = false

  const files = event.dataTransfer.files
  if (files.length === 0) return

  // Âè™Â§ÑÁêÜÁ¨¨‰∏Ä‰∏™Êñá‰ª∂
  const file = files[0]

  // È™åËØÅÊñá‰ª∂
  if (!validateFile(file)) {
    return
  }

  fileUploadState.value.selectedFile = file
  fileUploadState.value.filePreview = URL.createObjectURL(file)
}

/**
 * Ê∏ÖÈô§Êñá‰ª∂ÈÄâÊã©
 */
function clearFileSelection() {
  fileUploadState.value.selectedFile = null
  fileUploadState.value.filePreview = null
  fileUploadState.value.uploadProgress = 0
  if (fileInputRef.value) {
    fileInputRef.value.value = ''
  }
}

/**
 * Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
 */
function formatFileSize(bytes) {
  if (bytes === 0) return '0 B'
  const k = 1024
  const sizes = ['B', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
}

/**
 * ‰∏ãËΩΩÊñá‰ª∂
 */
function downloadFile(fileData) {
  if (!fileData || !fileData.fileId) return

  const downloadUrl = fileManagementApi.getDownloadUrl(fileData.fileId)

  // ÂàõÂª∫‰∏¥Êó∂ÈìæÊé•Âπ∂Ëß¶Âèë‰∏ãËΩΩ
  const link = document.createElement('a')
  link.href = downloadUrl
  link.download = fileData.fileName
  link.style.display = 'none'
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)

  console.log('‰∏ãËΩΩÊñá‰ª∂:', fileData.fileName)
}

/**
 * ‰∏ä‰º†Êñá‰ª∂
 */
async function uploadFile(file) {
  try {
    fileUploadState.value.isUploading = true
    fileUploadState.value.uploadProgress = 0

    const response = await fileManagementApi.uploadFile(file, false)

    if (response.code === 0 && response.data) {
      return response.data
    } else {
      throw new Error(response.message || 'Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•')
    }
  } catch (error) {
    console.error('Êñá‰ª∂‰∏ä‰º†Âá∫Èîô:', error)
    throw error
  } finally {
    fileUploadState.value.isUploading = false
    fileUploadState.value.uploadProgress = 0
  }
}

/**
 * ÂèëÈÄÅÊ∂àÊÅØÊé•Âè£ÔºàÊîØÊåÅÊñáÊú¨ÂíåÊñá‰ª∂Ôºâ
 * ‰ºòÂÖà‰ΩøÁî®WebSocketÂèëÈÄÅÔºåÂ§±Ë¥•Êó∂ÈôçÁ∫ßÂà∞HTTPËØ∑Ê±Ç
 */
async function handlerSubmitMsg() {
  // Ê£ÄÊü•ÊòØÂê¶ÊúâÂÜÖÂÆπÂèØÂèëÈÄÅ
  const hasText = msgContent.value.trim()
  const hasFile = fileUploadState.value.selectedFile

  if (!hasText && !hasFile) return

  isSendLoading.value = true

  const isGroupChat = targetId.value === '1'
  const targetUserId = isGroupChat ? null : targetId.value

  try {
    // Â¶ÇÊûúÊúâÊñá‰ª∂ÔºåÂÖà‰∏ä‰º†Êñá‰ª∂
    let fileData = null
    if (hasFile) {
      fileData = await uploadFile(fileUploadState.value.selectedFile)
    }

    // ÂáÜÂ§áÊ∂àÊÅØÂÜÖÂÆπ
    let messageContent = msgContent.value.trim()
    let messageType = 1 // ÈªòËÆ§ÊñáÊú¨Ê∂àÊÅØ

    if (fileData) {
      // ÊûÑÂª∫Êñá‰ª∂Ê∂àÊÅØÂÜÖÂÆπ
      messageContent = JSON.stringify({
        fileId: fileData.id,
        fileName: fileData.originalName,
        fileSize: fileData.size,
        fileUrl: fileManagementApi.getDownloadUrl(fileData.id),
        fileType: fileData.contentType
      })
      messageType = 2 // Êñá‰ª∂Ê∂àÊÅØÁ±ªÂûã
    }

    // ÁîüÊàêÂîØ‰∏ÄÁöÑ‰∏¥Êó∂IDÁî®‰∫éÊ∂àÊÅØÂÖ≥ËÅî
    const tempId = generateUUID()

    // ‰ºòÂÖà‰ΩøÁî®WebSocketÂèëÈÄÅÊ∂àÊÅØ
    if (chatStore.isConnected) {
      await chatStore.sendMessage(
        messageContent,
        targetId.value,
        isGroupChat ? 'GROUP' : 'PRIVATE',
        messageType
      )

      // Ê∑ªÂä†Ê∂àÊÅØÂà∞Êú¨Âú∞ËÆ∞ÂΩïÔºåÂàùÂßãÁä∂ÊÄÅ‰∏∫ÂèëÈÄÅ‰∏≠
      const localMessage = {
        tempId: tempId, // ‰∏¥Êó∂UUIDÔºåÁî®‰∫éÁ≤æÁ°ÆÂÖ≥ËÅî
        id: null, // ÁúüÂÆûIDÂæÖÊúçÂä°Âô®ËøîÂõû
        fromId: userInfoStore.value.userId,
        content: messageContent,
        isRecalled: 0,
        msgContent: fileData ? `[Êñá‰ª∂] ${fileData.originalName}` : messageContent,
        timestamp: new Date(),
        isFromMe: true,
        status: 'sending', // Ê∂àÊÅØÁä∂ÊÄÅÔºösending, sent, delivered, read
        messageType: messageType,
        fileData: fileData // ‰øùÂ≠òÊñá‰ª∂‰ø°ÊÅØÁî®‰∫éÊ∏≤Êüì
      }
      msgRecord.value.push(localMessage)
    } else {
      // WebSocketÊú™ËøûÊé•Êó∂ÈôçÁ∫ßÂà∞HTTPËØ∑Ê±Ç
      const messageData = {
        tempId: tempId, // ‰∏¥Êó∂UUIDÁî®‰∫éÁ≤æÁ°ÆÂÖ≥ËÅî
        targetId: targetUserId,
        groupId: isGroupChat ? 1 : null,
        content: messageContent,
        messageType: messageType
      }
      const response = await sendMessage(messageData)
      if (response.code === 0 && response.data) {
        // ÂêàÂπ∂ÊúçÂä°Âô®ËøîÂõûÁöÑÊï∞ÊçÆ‰∏éÊú¨Âú∞‰∏¥Êó∂Êï∞ÊçÆ
        const serverMessage = response.data
        serverMessage.tempId = tempId
        serverMessage.status = 'sent'
        serverMessage.fileData = fileData
        serverMessage.msgContent = fileData ? `[Êñá‰ª∂] ${fileData.originalName}` : messageContent
        msgRecord.value.push(serverMessage)
      } else {
        throw new Error(response.message || "ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•")
      }
    }

    // Ê∏ÖÁ©∫ËæìÂÖ•
    msgContent.value = ""
    clearFileSelection()
    scrollToBottom()

  } catch (error) {
    console.error("ÂèëÈÄÅÊ∂àÊÅØÂá∫Èîô:", error)
    // Â∞ùËØïHTTPÂ§áÁî®ÊñπÊ°à
    try {
      // ÈáçÊñ∞ÂáÜÂ§áÊï∞ÊçÆÔºàÂ¶ÇÊûúÊñá‰ª∂‰∏ä‰º†Â§±Ë¥•ÔºåÈúÄË¶ÅÈáçÊñ∞‰∏ä‰º†Ôºâ
      let fileData = null
      if (hasFile && !fileUploadState.value.selectedFile) {
        // Â¶ÇÊûúÊñá‰ª∂Â∑≤ÁªèË¢´Ê∏ÖÈô§ÔºåËÆ©Áî®Êà∑ÈáçÊñ∞ÈÄâÊã©
        alert('Êñá‰ª∂ÂèëÈÄÅÂ§±Ë¥•ÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©Êñá‰ª∂')
        return
      } else if (hasFile) {
        fileData = await uploadFile(fileUploadState.value.selectedFile)
      }

      let messageContent = msgContent.value.trim()
      let messageType = 1

      if (fileData) {
        messageContent = JSON.stringify({
          fileId: fileData.id,
          fileName: fileData.originalName,
          fileSize: fileData.size,
          fileUrl: fileManagementApi.getDownloadUrl(fileData.id),
          fileType: fileData.contentType
        })
        messageType = 2
      }

      const tempId = generateUUID()
      const messageData = {
        tempId: tempId,
        targetId: targetUserId,
        groupId: isGroupChat ? 1 : null,
        content: messageContent,
        messageType: messageType
      }
      const response = await sendMessage(messageData)
      if (response.code === 0 && response.data) {
        const serverMessage = response.data
        serverMessage.tempId = tempId
        serverMessage.status = 'sent'
        serverMessage.fileData = fileData
        serverMessage.msgContent = fileData ? `[Êñá‰ª∂] ${fileData.originalName}` : messageContent
        msgRecord.value.push(serverMessage)
        console.log("Ê∂àÊÅØÂ∑≤ÈÄöËøáHTTPÂèëÈÄÅ")
      } else {
        throw new Error(response.message || "HTTPÂèëÈÄÅÊ∂àÊÅØ‰πüÂ§±Ë¥•")
      }
    } catch (httpError) {
      console.error("HTTPÂèëÈÄÅÊ∂àÊÅØ‰πüÂá∫Èîô:", httpError)
      // ÊòæÁ§∫ÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫
      if (chatStore.isConnected) {
        alert("Ê∂àÊÅØÂèëÈÄÅÂ§±Ë¥•ÔºåÊ≠£Âú®Â∞ùËØïÈáçÊñ∞ËøûÊé•...")
      } else {
        alert("Ê∂àÊÅØÂèëÈÄÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÔºÅ")
      }
    }
  } finally {
    isSendLoading.value = false
  }
}

/**
 * Êí§ÂõûÊ∂àÊÅØÊé•Âè£
 * Ë∞ÉÁî®ÂêéÁ´Ø /api/v1/message/recall Êé•Âè£Êí§ÂõûÊåáÂÆöÊ∂àÊÅØ
 */
async function handleRecallMessage(msgId) {
  try {
    const res = await recallMessage(msgId)
    if (res.code === 0 && res.data) {
      const updatedMsg = res.data
      const idx = msgRecord.value.findIndex(m => m.id === msgId || m.tempId === msgId)
      if (idx !== -1) {
        msgRecord.value[idx] = updatedMsg
      }
    } else {
      alert(res.message || "Êí§ÂõûÊ∂àÊÅØÂ§±Ë¥•")
    }
  } catch (error) {
    console.error("Êí§ÂõûÊ∂àÊÅØÂá∫Èîô:", error)
    alert("Êí§ÂõûÊ∂àÊÅØÂá∫ÈîôÔºåËØ∑Á®çÂêéÂÜçËØïÔºÅ")
  }
}

/**
 * ÂàõÂª∫ÁßÅËÅäÔºöÂ¶ÇÊûúÁßÅËÅä‰∏çÂ≠òÂú®ÂàôÂàõÂª∫Êñ∞‰ºöËØù
 * ÈÄöËøá‰º†ÂÖ• userId Âíå username ÊûÑÈÄ†ÁßÅËÅä‰ø°ÊÅØ
 */
function onCreatePrivateChat(userId, username) {
  const exist = privateChatList.value.find(item => item.targetId === userId.toString())
  if (!exist) {
    privateChatList.value.push({
      id: userId.toString(),
      targetId: userId.toString(),
      targetInfo: { id: userId, name: username },
      lastMessage: ''
    })
  }
  targetId.value = userId.toString()
  currentSelectTarget.value = privateChatList.value.find(item => item.targetId === userId.toString())
}

/**
 * Â§ÑÁêÜÊâìÂ≠óËæìÂÖ•ÔºåÂèëÈÄÅÊâìÂ≠óÊåáÁ§∫Âô®
 */
function handleTypingInput() {
  if (!isTyping.value) {
    isTyping.value = true
    chatStore.sendTypingIndicator(targetId.value, true)
  }

  // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
  if (typingTimeout) {
    clearTimeout(typingTimeout)
  }

  // ËÆæÁΩÆÊñ∞ÁöÑÂÆöÊó∂Âô®Ôºå3ÁßíÂêéÂÅúÊ≠¢ÊâìÂ≠óÊåáÁ§∫Âô®
  typingTimeout = setTimeout(() => {
    isTyping.value = false
    chatStore.sendTypingIndicator(targetId.value, false)
  }, 3000)
}

/**
 * Ëé∑ÂèñÊ≠£Âú®ÊâìÂ≠óÁöÑÁî®Êà∑ÊñáÊú¨
 */
function getTypingUsersText() {
  const typingUsers = chatStore.isTyping[targetId.value] || {}
  const typingUserNames = Object.keys(typingUsers).filter(userId => typingUsers[userId] && userId !== userInfoStore.value.userId)

  if (typingUserNames.length === 0) return ''

  if (typingUserNames.length === 1) {
    const user = userList.value.find(u => u.id.toString() === typingUserNames[0])
    return user ? `${user.username} Ê≠£Âú®ËæìÂÖ•...` : 'Ê≠£Âú®ËæìÂÖ•...'
  }

  return `${typingUserNames.length} ‰∫∫Ê≠£Âú®ËæìÂÖ•...`
}

/**
 * Ê†ºÂºèÂåñÊ∂àÊÅØÊó∂Èó¥
 */
function formatMessageTime(timestamp) {
  if (!timestamp) return ''

  const date = new Date(timestamp)
  const now = new Date()
  const diff = now - date

  // Â¶ÇÊûúÊòØ‰ªäÂ§©ÁöÑÊ∂àÊÅØÔºåÊòæÁ§∫Êó∂Èó¥
  if (diff < 24 * 60 * 60 * 1000 && date.getDate() === now.getDate()) {
    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
  }

  // Â¶ÇÊûúÊòØÊò®Â§©ÔºåÊòæÁ§∫Êò®Â§©+Êó∂Èó¥
  const yesterday = new Date(now)
  yesterday.setDate(yesterday.getDate() - 1)
  if (date.getDate() === yesterday.getDate() && date.getMonth() === yesterday.getMonth() && date.getFullYear() === yesterday.getFullYear()) {
    return 'Êò®Â§© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
  }

  // Âê¶ÂàôÊòæÁ§∫ÊúàÊó•+Êó∂Èó¥
  return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }) + ' ' +
         date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
}

/* ---------------------- ËæÖÂä©ÂáΩÊï∞ ---------------------- */
// ÂÖ≥Èó≠Â∑¶‰æßÂíåÂè≥‰æßÊäΩÂ±âÔºàÁî®‰∫éÁßªÂä®Á´ØÁÇπÂáªÈÅÆÁΩ©ÂÖ≥Èó≠ËèúÂçïÔºâ
function closeMask() {
  showLeft.value = false
  showRight.value = false
}

// Ê®°ÊãüÊªöÂä®Âà∞Â∫ïÈÉ®ÔºåÈáçÁΩÆÊñ∞Ê∂àÊÅØËÆ°Êï∞
function scrollToBottom() {
  currentNewMsgCount.value = 0
}

/**
 * Â§ÑÁêÜÂπøÂëäÁÇπÂáª‰∫ã‰ª∂ÔºàÁ§∫‰æãÔºâ
 */
function handlerCardClick(card) {
  console.log('ÁÇπÂáª‰∫ÜÂπøÂëäÔºö', card)
}

// ÂàáÊç¢‰∏ªÈ¢òÔºàÁ§∫‰æãÈÄªËæëÔºâ
function toggleDark() {
  console.log('ÂàáÊç¢‰∏ªÈ¢ò(Á§∫‰æã)')
}

// ÁôªÂá∫Â§ÑÁêÜÂáΩÊï∞ÔºöÁõ¥Êé•‰ΩøÁî®authStore.logout()
function handlerLogout() {
  // Êñ≠ÂºÄWebSocketËøûÊé•
  chatStore.disconnectWebSocket()

  // ‰ΩøÁî®authStoreÁöÑlogoutÊñπÊ≥ïÔºåÂÆÉ‰ºöÂ§ÑÁêÜÂêéÁ´ØÈÄöÁü•ÂíåÁä∂ÊÄÅÊ∏ÖÁêÜ
  authStore.logout()

  // Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
  router.push('/login')
}

// ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠Ë°®ÊÉÖÂºπÁ™ó
function handleClickOutside(event) {
  if (isEmojiVisible.value && !event.target.closest('.emoji-popup') && !event.target.closest('.emoji-button')) {
    closeEmojiPopup()
  }
}

/* ---------------------- ÁîüÂëΩÂë®ÊúüÈí©Â≠ê ---------------------- */
onMounted(() => {
  // Ëé∑ÂèñËæìÂÖ•Âå∫ÂüüÂÆΩÂ∫¶ÔºàÁî®‰∫éËÆæÁΩÆË°®ÊÉÖÂºπÁ™óÂÆΩÂ∫¶Ôºâ
  if (inputAreaRef.value) {
    inputAreaWidth.value = inputAreaRef.value.getBoundingClientRect().width
  }

  // Ê∑ªÂä†ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∫ã‰ª∂ÁõëÂê¨
  document.addEventListener('click', handleClickOutside)

  // ËøûÊé•WebSocket
  console.log('ChatÈ°µÈù¢ÔºöËøûÊé•WebSocket...')
  chatStore.connectWebSocket()

  // ÁõëÂê¨WebSocketËøûÊé•Áä∂ÊÄÅÂèòÂåñ
  const unwatchConnection = watch(() => chatStore.isConnected, (isConnected) => {
    if (isConnected) {
      console.log('ChatÈ°µÈù¢ÔºöWebSocketËøûÊé•ÊàêÂäü')
      // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ËøûÊé•ÊàêÂäüÁöÑUIÊèêÁ§∫
    } else {
      console.log('ChatÈ°µÈù¢ÔºöWebSocketËøûÊé•Êñ≠ÂºÄ')
    }
  })

  // ÁõëÂê¨WebSocketÊ∂àÊÅØÔºåÊõ¥Êñ∞Ê∂àÊÅØÁä∂ÊÄÅ
  const unwatchMessages = watch(() => chatStore.messagesForCurrentChat, (newMessages) => {
    if (newMessages && newMessages.length > 0) {
      // Êõ¥Êñ∞Êú¨Âú∞Ê∂àÊÅØËÆ∞ÂΩïÔºåÂêåÊ≠•Ê∂àÊÅØÁä∂ÊÄÅ
      newMessages.forEach(newMsg => {
        if (newMsg.isFromMe) {
          // È¶ñÂÖàÂ∞ùËØïÈÄöËøá‰∏¥Êó∂IDËøõË°åÁ≤æÁ°ÆÂåπÈÖç
          let localMsg = msgRecord.value.find(m => m.tempId && m.tempId === newMsg.tempId)

          // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞‰∏¥Êó∂IDÂåπÈÖçÔºåÂõûÈÄÄÂà∞IDÂåπÈÖçÔºàÂÖºÂÆπÊóßÊï∞ÊçÆÔºâ
          if (!localMsg && newMsg.id) {
            localMsg = msgRecord.value.find(m => m.id === newMsg.id)
          }

          if (localMsg) {
            // Êõ¥Êñ∞Ê∂àÊÅØÁä∂ÊÄÅÂíåÁúüÂÆûID
            if (newMsg.status) {
              localMsg.status = newMsg.status
            }
            if (newMsg.id) {
              localMsg.id = newMsg.id // Êõ¥Êñ∞‰∏∫ÁúüÂÆûID
            }
            // ÁßªÈô§‰∏¥Êó∂IDÔºàÂèØÈÄâÔºâ
            if (newMsg.tempId && localMsg.tempId === newMsg.tempId) {
              delete localMsg.tempId
            }
          }
        }
      })
    }
  }, { deep: true })

  // ÂàùÂßãÂåñÔºöËé∑ÂèñÁî®Êà∑ÂàóË°®„ÄÅÁî®Êà∑ Map„ÄÅÂú®Á∫øÁî®Êà∑ÂíåÂΩìÂâçËÅäÂ§©ËÆ∞ÂΩï
  fetchUserList()
  fetchUserMap()
  fetchOnlineUsers()
  fetchChatRecord()
})

// ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ
onUnmounted(() => {
  console.log('ChatÈ°µÈù¢ÔºöÊñ≠ÂºÄWebSocketËøûÊé•')
  chatStore.disconnectWebSocket()
  // ÁßªÈô§ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∫ã‰ª∂ÁõëÂê¨
  document.removeEventListener('click', handleClickOutside)
})

// ÁõëÂê¨ targetId ÂèòÂåñÔºåÂàáÊç¢ËÅäÂ§©Êó∂Âä†ËΩΩÂØπÂ∫îÁöÑËÅäÂ§©ËÆ∞ÂΩï
watch(targetId, (newVal, oldVal) => {
  if (newVal !== oldVal) {
    fetchChatRecord()
  }
})
</script>


<style lang="less" scoped>
/* ===================== ‰∏ªÂÆπÂô®ÂèäËÉåÊôØ ===================== */
.chat-container {
  margin-bottom: 40px;
  width: 100%;
  height: 100%;
  position: absolute;
  background: var(--screen-bg-color);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}
.chat-bg {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  background-image: var(--screen-grid-bg-color);
  background-size: 50px 50px;
}

/* ===================== ÈÅÆÁΩ©Â±Ç ===================== */
.mask {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.1);
  z-index: 10;
}

/* ===================== Êñá‰ª∂‰º†ËæìÂºπÁ™ó ===================== */
.file-transfer-modal {
  position: fixed;
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: #ffffff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  z-index: 999;
}
.file-transfer-modal h3 {
  margin-top: 0;
}
.file-transfer-modal button {
  margin-top: 20px;
  padding: 8px 16px;
  background-color: #007BFF;
  color: #ffffff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.file-transfer-modal button:hover {
  background-color: #0056b3;
}


/* ===================== Áî®Êà∑‰ø°ÊÅØ‰øÆÊîπÂºπÁ™ó ===================== */
.modify-user-modal {
  position: fixed;
  top: 300px;
  left: 50%;
  transform: translateX(-50%);
  background: #ffffff;
  padding: 20px;
  z-index: 999;
  border-radius: 8px;
}

/* ===================== Ë°®ÊÉÖÂºπÁ™ó ===================== */
.emoji-popup {
  position: fixed;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 12px;
  z-index: 1000;
  max-height: 420px;
  max-width: 320px;
  overflow-y: auto;
  border-radius: 12px;
  border: 2px solid rgba(0, 123, 255, 0.3);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  animation: emoji-popup-enter 0.2s ease-out;
}

@keyframes emoji-popup-enter {
  from {
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.emoji-title {
  margin: 0 0 12px;
  text-align: center;
  font-size: 16px;
  font-weight: 600;
  color: #333;
  border-bottom: 1px solid rgba(0, 123, 255, 0.2);
  padding-bottom: 8px;
}

.emoji-search-container {
  margin-bottom: 12px;
}

.emoji-search-input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid rgba(0, 123, 255, 0.3);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.8);
  outline: none;
  font-size: 14px;
  transition: all 0.3s ease;
}

.emoji-search-input:focus {
  border-color: rgba(0, 123, 255, 0.6);
  background: rgba(255, 255, 255, 0.95);
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
}

.emoji-search-input::placeholder {
  color: #999;
}

.emoji-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 6px;
  max-height: 250px;
  overflow-y: auto;
  padding: 4px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.5);
}

.emoji-grid::-webkit-scrollbar {
  width: 4px;
}

.emoji-grid::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.1);
  border-radius: 2px;
}

.emoji-grid::-webkit-scrollbar-thumb {
  background: rgba(0, 123, 255, 0.5);
  border-radius: 2px;
}

.emoji-item {
  cursor: pointer;
  text-align: center;
  line-height: 32px;
  border-radius: 6px;
  font-size: 20px;
  transition: all 0.2s ease;
  user-select: none;
}

.emoji-item:hover {
  background: rgba(0, 123, 255, 0.1);
  transform: scale(1.1);
}

.emoji-item:active {
  transform: scale(0.95);
}

.emoji-pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 12px;
  gap: 8px;
}

.emoji-pagination-button {
  padding: 6px 12px;
  cursor: pointer;
  background: rgba(0, 123, 255, 0.1);
  border: 1px solid rgba(0, 123, 255, 0.3);
  border-radius: 6px;
  color: #007bff;
  font-size: 12px;
  transition: all 0.3s ease;
}

.emoji-pagination-button:hover:not(:disabled) {
  background: rgba(0, 123, 255, 0.2);
  border-color: rgba(0, 123, 255, 0.5);
}

.emoji-pagination-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.emoji-pagination-info {
  font-size: 12px;
  color: #666;
  font-weight: 500;
}

.emoji-package-container {
  margin-top: 12px;
  display: flex;
  justify-content: center;
  gap: 6px;
  flex-wrap: wrap;
}

.emoji-package-button {
  padding: 6px 12px;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.8);
  border: 1px solid rgba(0, 123, 255, 0.3);
  border-radius: 6px;
  font-size: 12px;
  transition: all 0.3s ease;
  color: #333;
}

.emoji-package-button:hover {
  background: rgba(0, 123, 255, 0.1);
  border-color: rgba(0, 123, 255, 0.5);
}

.emoji-package-button.active {
  background: rgba(0, 123, 255, 0.2);
  border-color: rgba(0, 123, 255, 0.6);
  color: #007bff;
  font-weight: 600;
}

.emoji-close-button {
  margin-top: 12px;
  display: block;
  width: 100%;
  padding: 8px;
  background: linear-gradient(135deg, #ff6b6b, #f44336);
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
}

.emoji-close-button:hover {
  background: linear-gradient(135deg, #ff5252, #d32f2f);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
}

/* ÂìçÂ∫îÂºèËÆæËÆ° - ÁßªÂä®Á´ØË°®ÊÉÖÂºπÁ™ó‰ºòÂåñ */
@media screen and (max-width: 480px) {
  .emoji-popup {
    max-width: calc(100vw - 20px);
    max-height: 350px;
    padding: 10px;
  }

  .emoji-grid {
    grid-template-columns: repeat(6, 1fr);
    max-height: 200px;
  }

  .emoji-item {
    font-size: 18px;
    line-height: 28px;
  }

  .emoji-package-container {
    gap: 4px;
  }

  .emoji-package-button {
    padding: 4px 8px;
    font-size: 11px;
  }
}

/* ===================== ËÅäÂ§©ÁõíÂ≠ê ===================== */
.chat-box {
  width: 80%;
  height: 90%;
  display: flex;
  position: relative;
  min-width: 0;
  @media screen and (max-width: 900px) {
    width: 95%;
    height: 95%;
  }
}

/* ---------------- Â∑¶‰æßËèúÂçïÔºàËÅäÂ§©ÂàóË°®Ôºâ ---------------- */
.box-left {
  width: 280px;
  min-width: 280px;
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(8px);
  margin-right: 5px;
  border-radius: 5px;
  border: 3px solid rgba(0, 123, 255, 0.5);
  display: flex;
  flex-direction: column;
  padding: 0 10px;
  @media screen and (max-width: 900px) {
    position: fixed;
    left: -280px;
    top: 0;
    bottom: 0;
    margin: 0;
    z-index: 11;
    transition: all 0.3s;
    background: rgba(255, 255, 255, 0.95);
    &.show-left {
      left: 0;
    }
  }
}
.chat-list-title {
  color: rgb(0, 123, 255);
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 600;
  user-select: none;
  position: relative;
}
.close-btn {
  cursor: pointer;
  font-size: 24px;
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  @media screen and (min-width: 900px) {
    display: none;
  }
}
.chat-list-item {
  height: 60px;
  margin-bottom: 5px;
  border-radius: 5px;
  display: flex;
  align-items: center;
  padding: 10px;
  cursor: pointer;
  user-select: none;
  position: relative;
}
.group-chat {
  background-image: url('/group-bg.png');
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
}
.chat-item-content {
  display: flex;
  flex-direction: column;
  justify-content: center;
  flex: 1;
  overflow: hidden;
}
.chat-content-name {
  font-weight: bold;
  margin-bottom: 5px;
  font-size: 14px;
  color: #000;
}
.chat-content-msg {
  font-size: 12px;
  color: #555;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.active-chat {
  background-color: rgba(0, 123, 255, 0.2);
}
.delete-chat-button {
  margin-left: 10px;
  background: #f00;
  color: #fff;
  border: none;
  border-radius: 4px;
  padding: 4px 8px;
  cursor: pointer;
}
.chat-avatar-small {
  width: 40px;
  height: 40px;
  background: #ccc;
  margin-right: 10px;
  border-radius: 50%;
}
.ad-container {
  margin-bottom: 10px;
}
.ad-image {
  width: 100%;
  border-radius: 5px;
  cursor: pointer;
}

/* ---------------- ‰∏≠Èó¥ÈÉ®ÂàÜÔºàÊ∂àÊÅØÂ±ïÁ§∫ÂèäËæìÂÖ•Âå∫Ôºâ ---------------- */
.box-middle {
  flex: 1;
  min-width: 300px;
  margin-right: 5px;
  border-radius: 5px;
  display: flex;
  flex-direction: column;
  @media screen and (max-width: 900px) {
    margin: 0;
  }
}
.middle-top {
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(8px);
  margin-bottom: 5px;
  border-radius: 5px;
  border: 3px solid rgba(0, 123, 255, 0.5);
  font-size: 18px;
  font-weight: 600;
  user-select: none;
  position: relative;
}
.menu-btn {
  cursor: pointer;
  font-size: 24px;
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
}
.menu-btn:first-of-type {
  left: 10px;
}
.menu-btn:last-of-type {
  right: 10px;
}
.middle-content {
  flex: 1;
  border-radius: 5px;
  background-image: linear-gradient(130deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.5));
  backdrop-filter: blur(10px);
  border: 3px solid rgba(0, 123, 255, 0.5);
  display: flex;
  flex-direction: column;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
.chat-show-area {
  flex: 1;
  padding: 10px;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 5px;
  margin-bottom: 10px;
}
.chat-message-container {
  background: #fff;
  padding: 10px;
  border-radius: 8px;
  max-width: 60%;
}
.bubble {
  background: #f0f0f0;
  color: #333;
  padding: 10px 15px;
  border-radius: 15px;
  word-wrap: break-word;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}
.msg-item {
  font-size: 20px;
  display: flex;
  margin-bottom: 8px;
}
.sending-indicator {
  text-align: center;
}
.new-msg-count {
  position: fixed;
  right: 15px;
  bottom: 80px;
  padding: 4px 15px;
  border-radius: 20px;
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(10px);
  color: rgba(0, 123, 255, 1);
  font-size: 14px;
  user-select: none;
  border: 2px solid rgba(0, 123, 255, 1);
  font-weight: 600;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
}

/* ---------------- ËæìÂÖ•Âå∫ÂüüÂèäÂèëÈÄÅÊåâÈíÆ ---------------- */
.chat-input-area {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 10px;
  margin: 15px 0;
  position: relative;
  transition: all 0.3s ease;
}

.chat-input-area.drag-over {
  background: rgba(64, 158, 255, 0.05);
  border: 2px dashed rgba(64, 158, 255, 0.3);
  border-radius: 10px;
}

.chat-input-area.drag-over::before {
  content: 'ÊãñÊãΩÊñá‰ª∂Âà∞ËøôÈáå‰∏ä‰º†';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #409eff;
  font-size: 16px;
  font-weight: 500;
  pointer-events: none;
  z-index: 10;
  background: rgba(255, 255, 255, 0.9);
  padding: 8px 16px;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(64, 158, 255, 0.2);
}
.chat-input-container {
  width: 80%;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 10px;
  overflow: hidden;
  padding: 10px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
.chat-msg-input {
  flex: 1;
}
.chat-text-input {
  width: 100%;
  outline: none;
  border: none;
  background: transparent;
  color: #000;
  font-size: 16px;
  padding: 5px;
}
.emoji-button {
  width: 28px;
  height: 28px;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  color: rgba(0, 0, 0, 0.5);
  user-select: none;
  position: absolute;
  right: 45px;
  top: 10px;
}

.file-button {
  width: 28px;
  height: 28px;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  color: rgba(0, 0, 0, 0.5);
  user-select: none;
  position: absolute;
  right: 10px;
  top: 10px;
  transition: color 0.3s;
}

.file-button:hover {
  color: rgba(0, 123, 255, 0.8);
}
.publish-button {
  height: 55px;
  width: 55px;
  border-radius: 10px;
  background: rgb(0, 123, 255);
  border: none;
  display: flex;
  justify-content: center;
  align-items: center;
  color: #fff;
  cursor: pointer;
  margin-left: 10px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  transition: background 0.3s, transform 0.3s;
}
.publish-button:hover {
  background: rgba(0, 123, 255, 0.8);
  transform: scale(1.05);
}
/* ÂèëÈÄÅÊåâÈíÆÁ¶ÅÁî®Áä∂ÊÄÅÊ†∑Âºè */
.publish-button:disabled {
  background: grey;
  cursor: not-allowed;
  opacity: 0.6;
}

/* ===================== Êñá‰ª∂È¢ÑËßàÂíå‰∏ä‰º†Ê†∑Âºè ===================== */
.file-preview-container {
  margin-top: 10px;
  padding: 8px;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 6px;
  border: 1px solid #e0e0e0;
}

.file-preview {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.file-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.file-name {
  font-size: 14px;
  font-weight: 500;
  color: #333;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 200px;
}

.file-size {
  font-size: 12px;
  color: #666;
}

.file-actions {
  margin-left: 8px;
}

.remove-file-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 16px;
  padding: 2px;
  border-radius: 3px;
  transition: background 0.3s;
}

.remove-file-btn:hover {
  background: rgba(244, 67, 54, 0.1);
}

.upload-progress {
  margin-top: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.progress-bar {
  flex: 1;
  height: 4px;
  background: #e0e0e0;
  border-radius: 2px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: #4caf50;
  transition: width 0.3s ease;
}

.progress-text {
  font-size: 12px;
  color: #666;
  min-width: 35px;
}

/* ===================== Êñá‰ª∂Ê∂àÊÅØÊ†∑Âºè ===================== */
.file-message {
  width: 100%;
}

.file-message-content {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.file-message-content:hover {
  background: rgba(255, 255, 255, 0.2);
}

.file-icon {
  font-size: 24px;
  flex-shrink: 0;
}

.file-details {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-width: 0;
}

.file-message .file-name {
  font-size: 14px;
  font-weight: 500;
  color: inherit;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.file-message .file-size {
  font-size: 12px;
  opacity: 0.8;
  color: inherit;
}

.download-hint {
  font-size: 12px;
  opacity: 0.7;
  color: inherit;
  white-space: nowrap;
}

/* ÂèëÈÄÅÊ∂àÊÅØ‰∏≠ÁöÑÊñá‰ª∂Ê∂àÊÅØÁâπÊÆäÊ†∑Âºè */
.bubble.sent-message .file-message-content {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.3);
}

.bubble.sent-message .file-message-content:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* ---------------- Âè≥‰æßËèúÂçï ---------------- */
.box-right {
  width: 280px;
  min-width: 280px;
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(8px);
  margin-left: 5px;
  border-radius: 5px;
  border: 3px solid rgba(0, 123, 255, 0.5);
  display: flex;
  flex-direction: column;
  padding: 0 10px;
  @media screen and (max-width: 900px) {
    position: fixed;
    right: -280px;
    top: 0;
    bottom: 0;
    margin: 0;
    z-index: 11;
    transition: all 0.3s;
    background: rgba(255, 255, 255, 0.95);
    &.show-right {
      right: 0;
    }
  }
}
.right-top {
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(8px);
  margin-bottom: 5px;
  border-radius: 5px;
  border: 3px solid rgba(0, 123, 255, 0.5);
  padding: 5px;
}
.user-info {
  display: flex;
  align-items: center;
}
.avatar2 {
  width: 40px;
  height: 40px;
  background: #888;
  border-radius: 50%;
  margin-right: 5px;
  cursor: pointer;
}
.user-name {
  font-size: 16px;
  font-weight: 600;
  color: #000;
}
.right-btn-group button {
  margin-left: 10px;
  padding: 4px 8px;
  cursor: pointer;
}
.right-content {
  flex: 1;
  min-height: 300px;
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(8px);
  border-radius: 5px;
  border: 3px solid rgba(0, 123, 255, 0.5);
  padding: 5px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
.user-list-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.user-search-input {
  border-radius: 5px;
  height: 30px;
  width: 140px;
  outline: none;
  border: 1px solid #ddd;
  padding: 0 8px;
}
.online-list {
  flex: 1;
  overflow-y: auto;
  padding-right: 5px;
  margin-right: -5px;
}
.online-list-item {
  height: 50px;
  border-radius: 5px;
  background-image: linear-gradient(
      to right,
      rgba(0, 123, 255, 0.2),
      rgba(0, 123, 255, 0)
  );
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
  position: relative;
}
.online-list-item.odd {
  background-image: linear-gradient(
      to left,
      rgba(0, 123, 255, 0.2),
      rgba(0, 123, 255, 0)
  );
}
.online-item-content {
  display: flex;
  align-items: center;
  position: relative;
}
.avatar1 {
  width: 40px;
  height: 40px;
  background: #aaa;
  border-radius: 50%;
}
.online-username {
  max-width: 100px;
  margin-left: 10px;
  font-weight: 600;
  color: #000;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.online-status {
  position: absolute;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  right: 0;
  bottom: 0;
  background: rgb(0, 123, 255);
  border: 2px solid #fff;
}
.online-item-operation {
  opacity: 0;
  transition: opacity 0.5s ease;
  pointer-events: none;
}
.online-list-item:hover .online-item-operation {
  opacity: 1;
  pointer-events: auto;
}
@media screen and (max-width: 900px) {
  .online-item-operation {
    opacity: 1;
    pointer-events: auto;
  }
}

/* ===================== ÊâìÂ≠óÊåáÁ§∫Âô®Ê†∑Âºè ===================== */
.typing-indicator {
  display: flex;
  align-items: center;
  padding: 10px 15px;
  margin: 5px 0;
  background: rgba(0, 123, 255, 0.1);
  border-radius: 15px;
  max-width: 200px;
}
.typing-dots {
  display: flex;
  align-items: center;
  margin-right: 8px;
}
.typing-dots span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #007bff;
  margin: 0 2px;
  animation: typing-animation 1.4s infinite;
}
.typing-dots span:nth-child(1) {
  animation-delay: 0s;
}
.typing-dots span:nth-child(2) {
  animation-delay: 0.2s;
}
.typing-dots span:nth-child(3) {
  animation-delay: 0.4s;
}
@keyframes typing-animation {
  0%, 60%, 100% {
    transform: translateY(0);
  }
  30% {
    transform: translateY(-10px);
  }
}
.typing-text {
  font-size: 14px;
  color: #666;
  font-style: italic;
}

/* ===================== Ê∂àÊÅØÁä∂ÊÄÅÊ†∑Âºè ===================== */
.message-actions {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  margin-top: 5px;
  font-size: 12px;
  color: #999;
}
.message-status {
  margin-bottom: 2px;
}
.status-sending {
  color: #ff9800;
}
.status-sent {
  color: #4caf50;
}
.status-delivered {
  color: #2196f3;
}
.status-read {
  color: #8bc34a;
}
.message-time {
  margin-bottom: 2px;
}
.recall-btn {
  background: #f44336;
  color: white;
  border: none;
  border-radius: 3px;
  padding: 2px 6px;
  cursor: pointer;
  font-size: 11px;
  transition: background 0.3s;
}
.recall-btn:hover {
  background: #d32f2f;
}

/* ===================== Ê∂àÊÅØÊ∞îÊ≥°Â¢ûÂº∫Ê†∑Âºè ===================== */
.bubble.sent-message {
  background: #007bff;
  color: white;
}

/* ===================== ÂÖ®Â±ÄÊªöÂä®Êù°Ê†∑Âºè ===================== */
.chat-container {
  background-color: white;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: gray #1a1a1a;
}
.chat-container::-webkit-scrollbar {
  background-color: white;
  width: 8px;
}
.chat-container::-webkit-scrollbar-track {
  background: #1a1a1a;
}
.chat-container::-webkit-scrollbar-thumb {
  background: white;
  border-radius: 4px;
}
</style>
