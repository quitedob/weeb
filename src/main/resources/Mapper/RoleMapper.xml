<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.web.mapper.RoleMapper">

    <resultMap id="RoleResultMap" type="com.web.model.Role">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="description" property="description"/>
        <result column="status" property="status"/>
        <result column="type" property="type"/>
        <result column="level" property="level"/>
        <result column="is_default" property="isDefault"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- 根据角色名称查询角色 -->
    <select id="selectByName" resultMap="RoleResultMap">
        SELECT * FROM role WHERE name = #{name} AND status = 1
    </select>

    <!-- 分页查询角色列表 -->
    <select id="selectRolesWithPaging" resultMap="RoleResultMap">
        SELECT * FROM role
        WHERE status = 1
        <if test="keyword != null and keyword != ''">
            AND (name LIKE CONCAT('%', #{keyword}, '%')
                 OR description LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY level ASC, created_at DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 统计角色数量 -->
    <select id="countRoles" resultType="int">
        SELECT COUNT(*) FROM role
        WHERE status = 1
        <if test="keyword != null and keyword != ''">
            AND (name LIKE CONCAT('%', #{keyword}, '%')
                 OR description LIKE CONCAT('%', #{keyword}, '%'))
        </if>
    </select>

    <!-- 检查角色名称是否存在 -->
    <select id="existsByName" resultType="boolean">
        SELECT COUNT(*) > 0 FROM role WHERE name = #{name}
    </select>

    <!-- 获取用户角色列表 -->
    <select id="selectRolesByUserId" resultMap="RoleResultMap">
        SELECT r.* FROM role r
        INNER JOIN user_role ur ON r.id = ur.role_id
        WHERE ur.user_id = #{userId} AND r.status = 1
        ORDER BY r.level ASC
    </select>

    <!-- 获取默认角色 -->
    <select id="selectDefaultRole" resultMap="RoleResultMap">
        SELECT * FROM role WHERE is_default = true AND status = 1
        ORDER BY level ASC LIMIT 1
    </select>

    <!-- 根据角色ID获取包含权限的角色 -->
    <select id="selectRoleWithPermissions" resultMap="RoleResultMap">
        SELECT r.* FROM role r WHERE r.id = #{roleId} AND r.status = 1
    </select>

    <!-- 为角色分配权限 -->
    <insert id="assignPermissionsToRole">
        INSERT INTO role_permission (role_id, permission_id, created_at)
        VALUES
        <foreach collection="permissionIds" item="permissionId" separator=",">
            (#{roleId}, #{permissionId}, NOW())
        </foreach>
    </insert>

    <!-- 从角色移除权限 -->
    <delete id="removePermissionsFromRole">
        DELETE FROM role_permission
        WHERE role_id = #{roleId} AND permission_id IN
        <foreach collection="permissionIds" item="permissionId" open="(" close=")" separator=",">
            #{permissionId}
        </foreach>
    </delete>

    <!-- 获取角色的权限ID列表 -->
    <select id="selectPermissionIdsByRoleId" resultType="long">
        SELECT permission_id FROM role_permission
        WHERE role_id = #{roleId}
    </select>

    <!-- 获取角色的权限名称列表 -->
    <select id="selectPermissionNamesByRoleId" resultType="string">
        SELECT p.name FROM permission p
        INNER JOIN role_permission rp ON p.id = rp.permission_id
        WHERE rp.role_id = #{roleId} AND p.status = 1
    </select>

    <!-- 清空角色的所有权限 -->
    <delete id="clearRolePermissions">
        DELETE FROM role_permission WHERE role_id = #{roleId}
    </delete>

    <!-- 复制角色权限 -->
    <insert id="copyRolePermissions">
        INSERT INTO role_permission (role_id, permission_id, created_at)
        SELECT #{targetRoleId}, permission_id, NOW()
        FROM role_permission
        WHERE role_id = #{sourceRoleId}
    </insert>

    <!-- 检查角色是否为系统角色 -->
    <select id="isSystemRole" resultType="boolean">
        SELECT COUNT(*) > 0 FROM role WHERE id = #{roleId} AND type = 0
    </select>

    <!-- 根据条件分页查询角色列表 -->
    <select id="selectRolesWithFilters" resultMap="RoleResultMap">
        SELECT * FROM role
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND (name LIKE CONCAT('%', #{keyword}, '%')
                 OR description LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY sort_order ASC, created_at DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 根据条件统计角色数量 -->
    <select id="countRolesWithFilters" resultType="int">
        SELECT COUNT(*) FROM role
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND (name LIKE CONCAT('%', #{keyword}, '%')
                 OR description LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
    </select>

</mapper>