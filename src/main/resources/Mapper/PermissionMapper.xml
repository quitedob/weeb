<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.web.mapper.PermissionMapper">

    <resultMap id="PermissionResultMap" type="com.web.model.Permission">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="description" property="description"/>
        <result column="resource" property="resource"/>
        <result column="action" property="action"/>
        <result column="condition" property="condition"/>
        <result column="status" property="status"/>
        <result column="type" property="type"/>
        <result column="group" property="group"/>
        <result column="sort_order" property="sortOrder"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- 根据权限名称查询权限 -->
    <select id="selectByName" resultMap="PermissionResultMap">
        SELECT * FROM permission WHERE name = #{name} AND status = 1
    </select>

    <!-- 根据资源和操作查询权限 -->
    <select id="selectByResourceAndAction" resultMap="PermissionResultMap">
        SELECT * FROM permission
        WHERE resource = #{resource} AND action = #{action} AND status = 1
    </select>

    <!-- 分页查询权限列表 -->
    <select id="selectPermissionsWithPaging" resultMap="PermissionResultMap">
        SELECT * FROM permission
        WHERE status = 1
        <if test="keyword != null and keyword != ''">
            AND (name LIKE CONCAT('%', #{keyword}, '%')
                 OR description LIKE CONCAT('%', #{keyword}, '%')
                 OR resource LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY sort_order ASC, created_at DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 统计权限数量 -->
    <select id="countPermissions" resultType="int">
        SELECT COUNT(*) FROM permission
        WHERE status = 1
        <if test="keyword != null and keyword != ''">
            AND (name LIKE CONCAT('%', #{keyword}, '%')
                 OR description LIKE CONCAT('%', #{keyword}, '%')
                 OR resource LIKE CONCAT('%', #{keyword}, '%'))
        </if>
    </select>

    <!-- 检查权限名称是否存在 -->
    <select id="existsByName" resultType="boolean">
        SELECT COUNT(*) > 0 FROM permission WHERE name = #{name}
    </select>

    <!-- 获取所有权限组 -->
    <select id="selectPermissionGroups" resultType="string">
        SELECT DISTINCT `group` FROM permission WHERE status = 1 AND `group` IS NOT NULL
    </select>

    <!-- 根据权限组查询权限 -->
    <select id="selectByGroup" resultMap="PermissionResultMap">
        SELECT * FROM permission
        WHERE `group` = #{group} AND status = 1
        ORDER BY sort_order ASC
    </select>

    <!-- 批量插入权限 -->
    <insert id="batchInsert" parameterType="list">
        INSERT INTO permission (
            name, description, resource, action, `condition`,
            status, type, `group`, sort_order, created_at, updated_at
        ) VALUES
        <foreach collection="permissions" item="permission" separator=",">
            (
                #{permission.name}, #{permission.description}, #{permission.resource},
                #{permission.action}, #{permission.condition}, #{permission.status},
                #{permission.type}, #{permission.group}, #{permission.sortOrder},
                #{permission.createdAt}, #{permission.updatedAt}
            )
        </foreach>
    </insert>

    <!-- 根据条件分页查询权限列表 -->
    <select id="selectPermissionsWithFilters" resultMap="PermissionResultMap">
        SELECT * FROM permission
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND (name LIKE CONCAT('%', #{keyword}, '%')
                 OR description LIKE CONCAT('%', #{keyword}, '%')
                 OR resource LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="resource != null and resource != ''">
            AND resource = #{resource}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY sort_order ASC, created_at DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 根据条件统计权限数量 -->
    <select id="countPermissionsWithFilters" resultType="int">
        SELECT COUNT(*) FROM permission
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND (name LIKE CONCAT('%', #{keyword}, '%')
                 OR description LIKE CONCAT('%', #{keyword}, '%')
                 OR resource LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="resource != null and resource != ''">
            AND resource = #{resource}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
    </select>

    <!-- 根据角色ID查询权限列表 -->
    <select id="selectPermissionsByRoleId" resultMap="PermissionResultMap">
        SELECT p.* FROM permission p
        INNER JOIN role_permission rp ON p.id = rp.permission_id
        WHERE rp.role_id = #{roleId} AND p.status = 1
        ORDER BY p.sort_order ASC
    </select>

</mapper>