# WEEB 角色权限体系说明

## 🎯 问题解决

### 原始问题
新用户注册后登录成功，但访问 `/api/users/me` 时遇到 "Access Denied" 错误。

### 根本原因
数据库中缺少角色和权限数据，导致新注册的用户无法获得必要的角色权限。

## 🏗️ 角色体系架构

### 角色层级（按权限级别排序）

| 角色名称 | 等级 | 是否默认 | 类型 | 描述 |
|---------|------|----------|------|------|
| 超级管理员 | 1 | ❌ | 系统角色 | 系统最高权限管理员 |
| 管理员 | 10 | ❌ | 系统角色 | 系统管理员 |
| 版主 | 50 | ❌ | 系统角色 | 内容版主 |
| 用户 | 100 | ✅ | 系统角色 | 普通用户（默认角色） |

### 权限分类

#### 用户管理权限
- `USER_READ` - 查看用户信息（自己的）
- `USER_UPDATE` - 更新用户信息（自己的）
- `USER_DELETE` - 删除用户（任何人的）
- `USER_CREATE` - 创建用户

#### 文章权限
- `ARTICLE_READ` - 查看文章
- `ARTICLE_CREATE` - 创建文章（自己的）
- `ARTICLE_UPDATE` - 更新文章（自己的）
- `ARTICLE_DELETE` - 删除文章（自己的）

#### 系统管理权限
- `SYSTEM_ADMIN` - 系统管理
- `ROLE_MANAGE` - 角色管理

### 角色权限映射

#### 超级管理员
- 拥有所有权限
- 可以执行系统管理、角色管理、用户管理、文章管理等所有操作

#### 管理员
- 拥有除系统管理外的所有权限
- 可以管理用户和文章，但不能修改系统配置和角色

#### 版主
- 拥有文章管理权限
- 可以创建、查看、更新、删除文章

#### 普通用户（默认角色）
- 拥有基础用户和文章权限
- 可以管理自己的信息和文章

## 🔧 实现机制

### 1. 数据库初始化（DatabaseInitializer.java）

```java
// 创建默认角色
INSERT INTO role (name, description, status, type, level, is_default) VALUES
('超级管理员', '系统最高权限管理员', 1, 0, 1, FALSE),
('管理员', '系统管理员', 1, 0, 10, FALSE),
('版主', '内容版主', 1, 0, 50, FALSE),
('用户', '普通用户', 1, 0, 100, TRUE);  // 默认角色
```

### 2. 用户注册时自动分配角色（AuthServiceImpl.java）

```java
// 为新用户分配默认角色
Role defaultRole = roleMapper.selectDefaultRole();  // 查找 is_default = true 的角色
if (defaultRole != null) {
    userRoleMapper.assignRoleToUser(user.getId(), defaultRole.getId());
} else {
    // 备选：查找"用户"角色
    Role userRole = roleMapper.selectByName("用户");
    if (userRole != null) {
        userRoleMapper.assignRoleToUser(user.getId(), userRole.getId());
    }
}
```

### 3. 现有用户角色修复

系统启动时会自动为没有角色的现有用户分配默认角色：

```java
// 获取所有没有角色的用户
List<Long> usersWithoutRoles = jdbcTemplate.queryForList(
    "SELECT u.id FROM user u LEFT JOIN user_role ur ON u.id = ur.user_id WHERE ur.user_id IS NULL",
    Long.class);

// 分配默认角色
for (Long userId : usersWithoutRoles) {
    jdbcTemplate.update(
        "INSERT INTO user_role (user_id, role_id, created_at) VALUES (?, ?, NOW())",
        userId, defaultRoleId);
}
```

## 🛡️ 安全保障

### 双重保障机制
1. **主要机制**：数据库角色权限系统
2. **备用机制**：CustomUserDetailsService 中的默认权限分配

```java
// CustomUserDetailsService.java:42
List<SimpleGrantedAuthority> authorities = userDTO.getAuthorityArray() != null ?
        Arrays.stream(userDTO.getAuthorityArray())
                .map(SimpleGrantedAuthority::new)
                .collect(Collectors.toList()) :
        Collections.singletonList(new SimpleGrantedAuthority("ROLE_USER"));
```

### 权限验证流程
1. 用户登录 → JWT Token 生成
2. 请求携带 Token → JwtAuthenticationFilter 验证
3. CustomUserDetailsService 加载用户权限
4. Spring Security 权限检查
5. 控制器方法执行

## 📊 数据库表结构

### role 表
```sql
CREATE TABLE `role` (
    `id` BIGINT NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(100) NOT NULL,
    `description` VARCHAR(255),
    `status` TINYINT DEFAULT 1,
    `type` TINYINT DEFAULT 0,          -- 0-系统角色，1-自定义角色
    `level` INT DEFAULT 100,           -- 角色等级（数字越小权限越大）
    `is_default` BOOLEAN DEFAULT FALSE, -- 是否为默认角色
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_name` (`name`)
);
```

### permission 表
```sql
CREATE TABLE `permission` (
    `id` BIGINT NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(100) NOT NULL,      -- 权限名称（如：USER_READ）
    `description` VARCHAR(255),
    `resource` VARCHAR(100),           -- 资源（如：user, article）
    `action` VARCHAR(100),             -- 操作（如：read, write）
    `condition` VARCHAR(255),          -- 条件（如：own, any）
    `status` TINYINT DEFAULT 1,
    `type` TINYINT DEFAULT 1,          -- 0-系统权限，1-业务权限
    `group` VARCHAR(100),              -- 权限分组
    `sort_order` INT DEFAULT 0,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_name` (`name`)
);
```

### user_role 表（用户-角色关联）
```sql
CREATE TABLE `user_role` (
    `id` BIGINT NOT NULL AUTO_INCREMENT,
    `user_id` BIGINT NOT NULL,
    `role_id` BIGINT NOT NULL,
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_user_role` (`user_id`, `role_id`)
);
```

### role_permission 表（角色-权限关联）
```sql
CREATE TABLE `role_permission` (
    `id` BIGINT NOT NULL AUTO_INCREMENT,
    `role_id` BIGINT NOT NULL,
    `permission_id` BIGINT NOT NULL,
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_role_permission` (`role_id`, `permission_id`)
);
```

## 🚀 验证步骤

### 1. 重启应用
系统会自动初始化角色和权限数据。

### 2. 检查日志
确认看到以下日志：
```
✅ 默认角色创建成功
✅ 基础权限创建成功
✅ 超级管理员权限分配完成
✅ 管理员权限分配完成
✅ 版主权限分配完成
✅ 普通用户权限分配完成
✅ 为 X 个现有用户分配了默认角色
```

### 3. 测试新用户注册
1. 注册新用户
2. 登录
3. 访问 `/api/users/me` - 应该正常返回用户信息

### 4. 测试现有用户
1. 使用现有用户登录
2. 访问 `/api/users/me` - 应该正常返回用户信息

## 🔄 后续维护

### 添加新角色
```sql
INSERT INTO role (name, description, status, type, level, is_default) VALUES
('新角色', '角色描述', 1, 1, 80, FALSE);
```

### 添加新权限
```sql
INSERT INTO permission (name, description, resource, action, condition, status, type, group, sort_order) VALUES
('NEW_PERMISSION', '权限描述', 'resource', 'action', 'condition', 1, 1, '分组', 1);
```

### 为角色分配权限
```sql
INSERT INTO role_permission (role_id, permission_id) VALUES (roleId, permissionId);
```

## 🎉 总结

通过这个完整的角色权限体系：

1. **新用户自动获得权限**：注册时自动分配默认角色
2. **现有用户权限修复**：系统启动时为无角色用户分配默认角色
3. **层级化权限管理**：不同角色拥有不同级别的权限
4. **灵活的权限配置**：可以轻松添加新角色和权限
5. **安全保障**：双重保障机制确保用户总能有基本权限

这样就彻底解决了 "Access Denied" 问题，并建立了一个完整的角色权限管理体系！